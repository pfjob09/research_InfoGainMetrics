Analyzing the Evolution of
Large Scale Structures in
the Universe with Velocity Based Methods
Uliana Popov, Eddy Chandra, Katrin Heitmann, Salman Habib,
James Ahrens, and Alex Pang

ABSTRACT

The formation of cosmic structure results from the action of gravity
on matter in an expanding Universe. As the evolution proceeds, the
velocity field changes from being single-valued almost everywhere
in space to being multi-valued over a complex web of 'multistream­
ing' regions associated with the formation of large-scale structure
(LSS) such as halos (or clumps), filaments, and sheets.
Until recently, these structures have been investigated primar­
ily via the (scalar) mass density field. In this application paper
we apply data analysis and visualization techniques to cosmolog­
ical simulations with the aim of studying multistreaming regions
using velocity-based probes. Compared to the current practice of
using density information (e.g., morphology estimators, locating
overdense regions with halo finders), we show that velocity-based
methods can provide useful supporting, as well as complementary,
information. Because the density field and multistreaming are cor­
related but do not contain the same information, new and inter­
esting information about the properties of the large-scale structure
may be extracted, e.g., capturing dynamical behavior not possible
with density-based estimators. Incorporating a novel method for
setting thresholds for the velocity-based estimators, we study the
relationships between the density field as represented by compact
overdense halos and the different properties of multistreaming re­
gions as represented by different velocity-based estimators.
1

INTRODUCTION

Over the last two decades cosmology has made extremely rapid
progress. There now exists a cosmological "Standard Model" that
is in very good agreement with a large number of observational
datasets at better than the 5 10% level of accuracy. A key fea­
ture of the model is the existence of a "dark" sector that is not
directly observable by emission or absorption of light but the ex­
istence of which can be inferred via its dynamical effects, by grav­
itational lensing, and by its influence on the formation of cosmic
structure. Observations indicate that 73% of the Universe consists
of a mysterious dark energy, 23% of a yet unidentified cold dark
matter (COM), and only a small fraction of the remaining 4% of
ordinary (atomic) matter is visible [\ I]. Understanding the physics
of the dark sector is the foremost challenge in cosmology today.
The evolution and dynamics of the dark matter distribution can
be investigated by following the formation of cosmic structure as
observed in the distribution of galaxies. The structure is often
characterized by the effective dimensionality of its spatial distri­
bution, e.g., galaxy clusters ('00'), filaments ('\0'), and surface­
like sheets or pancakes ('20'). A hint of the complex geometry and
topology of cosmic structure is illustrated in Figure I.
Precision dark matter simulations are a key foundation of cosmo­
logical studies. These simulations track the evolution of the dark
matter with very high resolution in time, force, and mass. At the
-

IEEE Pacific Visualization Symposium 2012
28 February - 2 March, Songdo, Korea
978-1-4673-0866-3/12/$31.00 ©2012 IEEE

•

cluster

9·
Figure 1: Large scale cosmological structures of the universe.

scales of interest to structure formation, a Newtonian approxima­
tion in an expanding universe is sufficient to describe gravitational
dynamics. The evolution is given by a collisionless V lasov-Poisson
equation [7], a six-dimensional partial differential equation. This is
solved using anN-body approach. The six-dimensional phase space
distribution is sampled by "tracer" particles and these particles are
evolved by computing the inter-particle gravitational forces.
The starting point of the simulations is a Gaussian random den­
sity field which imprints small perturbations on a uniform density,
isotropic universe. The simulations start in the linear regime of
the density fluctuations which then evolve under the influence of
gravity. At any given length scale, during the early stages, the evo­
lution remains linear but as time progresses, evolution first enters
the quasi-linear regime, where perturbation theory can be applied,
before finally reaching the fully nonlinear regime at which point
all analytic descriptions break down. There is substantial inter­
est in determining and characterizing the transitions between lin­
ear, quasi-linear, and nonlinear dynamical regimes. At the start
of the simulation, the velocity dispersion is zero, and the phase­
space distribution is a three-dimensional sub-manifold of the phase
space - only one velocity direction at a given spatial point. As the
3-hypersurface evolves, it folds, leading to the occurrence of sin­
gularities in the density field corresponding to the appearance of
regions with multistream flow.
Finding and characterizing multistreaming regions in cosmolog­
ical simulations is an important endeavor for several reasons. The
onset of multistreaming and the evolution of multistreaming regions
as part of the theory of nonlinear structure formation is certainly in­
teresting in of itself. It is an important aspect in understanding the
formation of galaxy clusters where several "cold flows" combine
and is relevant on more local scales as well, such as for dark matte;
detection experiments.

49

p

Figure 2: Illustration of 1-0 multi-stream flow. Top panel: High den­
sity region with three-stream flow confined between the dashed lines.
Bottom panel: The corresponding phase space plot showing the dif­
ferent stream regions [18].

The validity of approximate methods such as perturbation theory
is intimately connected with the onset of multistreaming. Since run­
ning large cosmological simulations is very costly, it is important to
find methods that can provide accurate answers without expensive
simulations. A key cosmological statistic, the density fluctuation
power spectrum, can be predicted over a range of (large) length
scales by perturbation theory. However, the prediction accuracy
breaks down at smaller scales once these scales go nonlinear, in
part associated with multistreaming. Here, we use this relationship
to set thresholds for velocity based multistreaming estimators.
Traditionally, LSS is investigated primarily by considering the
distribution of dark matter clumps, called halos. Halos host very
large numbers of streams, though more general morphology esti­
mators are also coming into use. Although there are differences
between methods, halos are typically identified by thresholding on
the density of tracer particles. For a description of halo finders, see
[\3). In this paper, we are concerned not so much with density, but
with how the velocity information of tracer particles can be used to
find and characterize multistreaming regions.
2

MULTISTREAMING

The data inN-body cosmological simulations is presented as a large
collection of particles with known positions and velocities. Because
this particle ensemble corresponds to a weighted random sampling
of six-dimensional phase space with unknown weighting, a precise
way of describing multistreaming in simulations is still lacking.
Recently there has been some progress in counting the number of
streams locally using a tessellation method [ I7, \]. However, this is
only one single aspect of the problem. The availability of a general
toolkit with which to investigate multistreaming regions is highly
desirable. In this paper, we derive and investigate several velocity
based multistreaming extractors based on phenomenological ideas,
some taken from the current literature.
Multistreaming occurs when there are multiple velocities at a
given spatial point. Figure 2 provides a simple illustration for a one­
dimensional cold, collisionless medium [18). In the phase space
plot (bottom panel), the boundary between a three-stream flow and
a single stream is denoted by the dashed lines. At the boundaries,
there is a shell-crossing singularity (caustic) in the density field
because the mapping from phase space to configuration space be­
comes multi-valued. This picture generalizes to higher dimensions.
According to current theories of structure formation, the initial
condition for a simulation corresponds to starting with a unique,

50

smoothly varying, fluid velocity at every spatial point. As evolution
proceeds, nonlinearities induce singularities in the flow, as shown
in Figure 2. These singularities in configuration space, or caustics,
are associated with the existence of multiple flow directions at a
single point. Even though each stream or flow is curl-free or irrota­
tional, the vorticity of the velocity field is no longer zero, that is, the
velocity field no longer corresponds to a potential flow. Moreover,
as again demonstrated in Figure 2, the caustic regions correspond
to very high densities, and so aside from other issues of dynam­
ical complexity, conventional perturbation theory breaks down in
multistreaming regions [15].
Based on this picture, we can investigate several avenues for
identifying multistreaming regions and investigating their proper­
ties via velocity based analyses. For example, we can look for re­
gions where the flow has non-zero vorticity, examine the divergence
field to see where particles may possibly congregate, examine the
linearity of the flow field, and check similarity of velocities, as well
as velocity dispersion. Local flow behaviors that can serve as di­
agnostics for multistreaming include: (i) particle flows having dif­
ferent speed and direction, or (ii) particles flows having the same
speed but different direction, or (iii) particles flows having different
speeds but the same direction. So, checking the shear in the flow
may provide some useful information as well. We explore these
ideas in more detail in Section 5.
3

PREVIOUS WORK

The visualization of cosmological data sets has received significant
attention for both grid and particle-based data. The vast majority of
gravity-only cosmological simulations are particle-based, while in­
clusion of hydrodynamics is most often associated with grid-based
data. The sizes of N-body simulations, measured by the number
of particles, have increased exponentially as larger computing re­
sources have become available, aiding the capturing of physical
phenomena over a very wide range of length scales.
Within the visualization community, several efforts have focused
on astrophysical data sets. A few examples of these include the
work of Li et al. [12], who explored how to display positional and
trajectory uncertainties in astrophysical data set and Fraedrich et
al. [6], who focused on scalable rendering of large cosmological
simulations using a combination of hierarchical level-of-detail and
GPU acceleration approaches. While these studies are relevant for
dealing with the issues related to visualizing cosmological simula­
tion data, they are different from the work in this paper in that we
are primarily interested in feature extraction in such data sets, with
multistream flows as the target.
The identification of multistreaming regions has also been ex­
plored in recent years; this work includes studies ofN-body simu­
lations using a special tessellation method [17, I). Regions of high
density are associated with multistreaming, although there is not a
one-to-one correspondence between the density and the number of
streams. The overdensity contrast can be used to define compact
high-density regions called halos, and, depending on the problem
of interest, one may vary the density threshold to capture the ha­
los of interest. One of the common approaches for finding halos
uses the Friends-Of-Friends (FOF) group finder [5, 4). The basic
idea behind FOF is to carry out an extended neighbor search using
a fraction of the average inter-particle spacing, the 'link length', as
the search radius. Pairs of particles that are closer than the link
length are connected together, resulting in a network of linked par­
ticles, one such particle cluster defining a single FOF halo. The
choice of link length corresponds roughly to setting an isodensity
contour. We will compare our results to the FOF halo finder imple­
mented in ParaView 3. \0 [21). An extensive survey of other halo
finders can be found in [10].
As one method to detect multistreaming, we note that in flows
with high shear, locally particles will move at drastically differ-

ent rates and in different directions. One way to detect such re­
gions in three dimensions is to form tetrahedral volume elements
from four nearby particles. By tracking these tetrahedral volume
elements over time, multistreaming regions can be detected when
there is a change in the sign of the tetrahedral volume. This hap­
pens because a tetrahedron vertex can penetrate through the tetra­
hedron causing its volume to flip sign (the moment all vertices are
co-planar, the volume is zero, and the local sheet defines a caustic
surface) [3]. However, this approach tends to be computationally
expensive since it requires multiple time frames of large data sets.
More recently, Shandarin [16] proposed a new approach to iden­
tify the cosmic web based on finding multistream flows. Instead
of relying solely on the density of particles, Shandarin's technique
incorporates particle velocity information along with positional in­
formation. He used the local velocity variance to identify multi­
streaming events. Prior to his work, we have also used particle ve­
locity information to identify multistreaming events. In that work,
smaller simulations with 643 and 2563 particles were employed.
The analysis and results reported in this paper are based on sim­
ulations consisting of 5123 particles within a box that measures
256 h-1 Mpc along each side. 1Mpc c:::: 3,262,000 light-years and
h Hall OOkm/s/Mpc is a dimensionless constant designed histor­
ically to compensate for uncertainties in the value of the Hubble
constant, Ha. The current value is h 0.72. Higher resolution data
sets allow us to resolve multistreaming regions over a wider range
of length scales.
=

=

4

TIME AND SCALE DEPENDENT THRESHOLDS

In most approaches, including ours, finding velocity based multi­
streaming regions assumes the existence of a continuous velocity
field. Several options are available for converting the discrete par­
ticle velocity information into field information on a regular mesh,
where some form of continuity may be assumed. In this paper, we
use the c1oud-in-cell (CIC) method to generate a velocity field from
the individual particle velocities. CIC [8] uses a weight factor to
account for the distance of the particle to its closest grid points, Le.,
the velocity of each particle is distributed, using a distance-based
weight factor, amongst the grid points of the cell containing the
particle. This method is a good compromise in terms of speed and
smoothness of the resulting field. It is also the same method used
in the simulation code to solve for the gravitational force acting on
the particles. The choice of grid resolution is important: If the grid
is too coarse, the particle deposition will oversmooth the data and
multistreaming events may be lost. On the other hand, if the grid
is too fine, it results in a low particle count per cell and increased
noise, not to mention added computational expense. For our inves­
tigation, we choose a grid resolution such that on average there are
64 particles contributing to each grid point.
The demonstration data set used for this investigation contained
5123 particles for each time frame. The simulation run consisted
of 499 time frames from redshift z 50 at the earliest snapshot, to
z
0 in the current epoch, using a box size of Lbox 256 h-1 Mpc
per side. The entire data set totaled 2 terabytes. To achieve the
desired average particle density per cell, we used a regular grid with
2563 cells for converting the particle velocities into a continuous
velocity field. In principle, our proposed techniques can be applied
to much larger data sets such as the Millennium [19] or Bolshoi [9]
simulations. As explained below, the chosen grid size also allows
us to find multistreaming regions early on in the evolution. Note
that as time progresses, some regions become more dense while
others become more sparse or even empty. Empty cells as well as
those in their immediate vicinity must be treated with care and are
specially marked so that they do not produce erroneous results in
the analysis.
As structure evolves and density contrast grows, multistreaming
occurs at different scales and increases over time in the sense that
=

=

=

�

�
:;:

6283.2

L

628.32

[MpC/h]
62.83

6.28

0.63

1.1

�n

.a
c

gth scales covered by simulation

.c

�

�
c..

1.05

�
�

"E
a

-g
a
�

'g.

�
:;:

a=0.020...=0.021
... =0.0]230=0.048-

.a
c

.c

a

0.95

�

30=0.167-

c..

a=0.200

""
�

E
E

�

ct:

a=O.091
a=O.IOO
30=0.125a=O.IIIa=O.I1)-

a=0.250..=0.)])a=0.500
a=l.000
0.9
0.001

0.01

k

0.1

10

[h/Mpc]

Figure 3: Breakdown of perturbation theory at different times, here
represented by the scale factor (a), and different length scales (L).
The curves are the ratio of two different perturbation theories. Rapid
deviations from unity signal a breakdown of perturbation theory. The
breakdown occurs at increasingly large scales with lime. For exam­
ple, the yellow curve, at a

=

I, breaks away at a larger length scale

than the cyan curve, at a

=

0.5.

AI the top of the plot we indicate

length scales, with wave numbers at the bottom. The vertical dashed
lines in red mark the limits of the scales covered by the simulation
data.

the number of streams increases, as also the volume of the multi­
streaming regions, up to a point. Initially, sheet-like multistreaming
regions form three-stream flows, which later coalesce in a complex
manner into filamentary and clumpy multistreaming regions. The
last can have a very large number of streams [17, I]. Hence, an im­
portant issue in searching for multistreaming regions of interest is
to have a rough prediction for their length scales at different times.
The length scale estimate is essential for our approach, since we
have to make a choice of threshold when using the velocity based
extractors described in Section 5. We describe below a method for
estimating length scales that can be used to set thresholds for the
extractors.
In order to carry out one such estimation, we examine when per­
turbative structure formation theory fails. The small overdensity
(perturbative) treatment of gravitational clustering breaks down in
regions where multistreaming occurs. Our argument is based on an
internal check within this analysis. We first note that perturbation
theory can be carried out at different orders in the density perturba­
tion. In the regimes where perturbation theory works, higher-order
corrections serve to improve the lower-order results. However, once
the fluctuations are too large, consistency between orders no longer
exists, and different order results can disagree strongly. By inves­
tigating at what scales two different approaches, at different orders
of the perturbation, diverge from each other, we can estimate the
scale where perturbation theory fails, and hence produce a candi­
date scale for the onset of multistreaming.
Following Carlson et al. [2], we calculate the matter power spec­
trum for second order perturbation theory and a re-summed scheme
with a code provided by the authors. We then take the ratio of
these power spectra at different epochs. The results are shown in
Figure 3 at different time-steps corresponding to cosmological ex­
pansion scale factors a ( t ) between a 0.02 and a 1.0 (today). a
represents the relative expansion of the Universe, and is related to
the cosmological redshift via a (z) 1/(1 +z) . The dashed verti=

=

=

51

a

0.500
0.333
0.250
0.200
0.167
0.111
0.125
0.111
0.100
0.091
0.045
0.033
0.020

Frame #
248
165
123
95
80
70
60
52
47
43
21
l3
7

Redshift Z
1
2
3
4
5
6
7
8
9
10
20
30
50

L scale 10%
37 h -lMpc
30 h-I Mpc
24 h-I Mpc
18 h-I Mpc
14 h-I Mpc
l O h-I Mpc
8 h-I Mpc
6 h-I Mpc
5.8 h-I Mpc
5.6h-IMpc
2 h-I Mpc
1 h-I Mpc
0.9h-IMpc

L scale 5%

43 h -lMpc
34 h-I Mpc
27 h-I Mpc
24 h-I Mpc
19 h-I Mpc
12 h-I Mpc
I O h-I Mpc
8 h-I Mpc
7 h-I Mpc
6 h-I Mpc
3 h-I Mpc
1.05 h-I Mpc

0.98 h-IMpc

Table 1: This table shows the relationship between the expansion
scale factor a, the redshift z, and the frame number of the simulation,

and the corresponding length scale for two different tolerances (5%
and 10% deviations, using the data of Figure 3) defining the break­
down of perturbation theory, the result being only mildly sensitive to
this choice. For further discussion, see the text.

that the multistreaming regions decrease in size until there is only
one region with the expected feature size; this fixes the threshold
value for that frame. Because the growth of region size is fairly
well behaved (See Table 1), we can use the final threshold value of
the current frame as the initial guess for the next frame, and so on.
In Section 6, we will investigate the success of this method for
setting thresholds by comparing the multistream regions found by
the velocity based estimators against a density-based halo catalog.
The halo catalog serves two purposes: (i) it allows a (compressed)
visual presentation of the density, and more importantly (ii) halos
are compact multistreaming regions with high stream counts, so
they should be consistently captured by the estimators.
5

5.1

cal line on the right of the Figure indicates the resolution limit due
to smoothing from the density calculation. This cutoff depends on
the CIC grid size. An increase moves the cutoff lower, a reduction
moves it higher. Although one cannot increase it beyond a certain
point set by particle spacing limits in the simulation. The smallest
length scale we can resolve is 0.256 h-I M�c. Using a grid of 2563
cells, we can resolve length scales of 1 h- Mpc. However, when
coupled with CIC, with window size equal to one cell, our resolu­
tion drops to length scales of 2 h-I Mpc. The vertical line on the
left denotes the smallest wave number which is set by the box size,
the minimum k 2n/Lbox � 0.02h/Mpc.
An estimate of when, and at what length scales, significant mul­
tistreaming will likely occur is given by the scales at which the per­
turbative results deviate from each other, i.e., a deviation from unity
in Figure 3. The wave number k associated with the breakdown de­
creases with time, implying that multistreaming regions relevant to
the breakdown of perturbation theory start out as smaller structures
which grow larger over time - by a factor of 40 in length scale, L.
Table 1 is based on the predictions from Figure 3. It lists the ex­
pected size of the multistreaming scales for different snapshots in
the simulation data, based on 5% and 10% tolerances. Since the
breakdown is steep, as seen in Figure 3, the derived length scale is
relatively insensitive to the choice of tolerance; we have used the
10% tolerance to determine the thresholds for the velocity based
estimators. Note that at the earliest times, the length scales are
small and the structures have to be resolved down to that scale in
the analysis. These scales are of order Ih-I Mpc, comparable to
our choice of CIC resolution.
We use Table 1 to set thresholds appropriate for each epoch in
the simulation. For example, at frame 250, we expect large multi­
streaming regions to have a length scale of about 37 h-I Mpc. Using
this as a constraint, our aim is to find a threshold value for the cho­
sen estimator that will produce regions of this expected size. Since
the regions come in a variety of shapes, and because the length scale
itself is only approximate, we have developed an operational pro­
cedure for setting the thresholds. We do this by defining the region
size as the number of connected grid points that are above the cur­
rent threshold. To determine the appropriate threshold for a given
frame, the initial threshold, thresholdo, is arbitrarily set to a value
that will result in all points being classified as multistreaming ac­
cording to the feature extractor. It is then systematically adjusted so
=

�

52

VELOCITY BASED EXTRACTORS

In this section, we present six velocity based extractors to charac­
terize multistream regions based on the previous discussion in Sec­
tion 2. They are based on various local descriptions of multistream­
ing using velocity field information alone; as a result the methods
are computationally efficient. Because the vectorial information
contained in velocity fields is more complex than scalar density
information, the velocity based estimators each access somewhat
different dynamical properties of the matter distribution.
Velocity Field Gradient Anisotropy

Particles moving in opposite directions or even in the same direc­
tion but at different speeds can lead to shear in the velocity field; this
shear is a possible diagnostic of multistreaming, although strictly
speaking multistreaming relates to multiple flows at the same spa­
tial point. To find regions of high velocity field gradients, we first
calculate the velocity gradient tensor, the tensor product V ® V,
where V is the 3-space vector differential operator. We then find
its symmetric tensor components, and the associated real eigenval­
ues AI'�' and .1.,3' To reduce everything to a single scalar, we use
an analog of the von Mises criterion originally introduced in the
context of stress in plastic flow [20], and defined as:

Note that as flows become isotropic, i.e. Al � �, this es­
timator goes to zero. Hence, this particular feature detector is a
diagnostic for regions that exhibit high shear as indicated by high
levels of anisotropy. Other types of anisotropic measures could be
used in place of the von Mises criterion-motivated quantity.
=

5.2

=

Divergence

Defined as V· V, the divergence of a vector field is a scalar quantity
that provides a measure of the degree to which the field is a source
or a sink at a given location. Positive values indicate a source-like
behavior, while negative values indicate a sink-like behavior. The
motivation for using divergence for finding multistreaming is that it
locates regions where particles congregate, as occurs in the cosmo­
logical context for gravitational localization along sheets, filaments,
or localized regions (halos). Note that the divergence is simply the
trace of the velocity gradient tensor defined above.
5.3

Vorticity

In fluid dynamics, a central notion is the concept of rotation associ­
ated with vector fields. A primary diagnostic for this is the vorticity
which measures the local angular rate of rotation in a fluid. Itself a
vector, the vorticity is defined as the curl of the velocity field, V x V.
In multistreaming regions, the individual streams remain curl-free,
i.e., have zero vorticity (irrotational flow). However where streams
cross, the vorticity is nonzero, hence the magnitude of the vorticity
provides a direct measure of multistreaming.

5.4

Dot Product

Particles inside multistreaming regions have different velocities.
We can measure the degree to which a set of vectors are simi­
lar or different using the dot product; for two vectors: W and D,
W· D I,7=1 Wi' ui. Note that the dot product is sensitive to vector
directions and magnitudes. For this metric, we are primarily inter­
ested in the directional information. Hence, we calculate the dot
product of normalized vectors at a grid. The normalized dot prod­
uct measures the angular difference between pairs of vectors. The
range of this metric is [-1..1] corresponding to 180 degrees (signi­
fying opposite directions), to 0 degrees (signifYing the same direc­
tion). Since the shear metric already accounts for situations where
particles are going in the same direction with different speeds or op­
posite directions with the same speeds, we tailor the normalized dot
product metric to find only those regions where vectors are crossing
each other at large angles. Specifically, we use the absolute value
of the normalized dot product. Values closer to zero indicate re­
gions with crossing vectors. To calculate this estimator, we take the
dot product of the normalized velocity field at a grid point with the
normalized velocity field from the six nearest-neighbor points, and
average the result.
=

5.5

than 25.8 degrees. This criterion is currently somewhat ad hoc and
more experience with this measure is needed to aid in addressing
this issue. If a vector pair is similar according to this criterion, we
assign it a value of 1, else a O. A grid vertex is determined to be
'nonlinear' based on the number of neighboring cells that are sim­
ilar. An aggregate value of 0 means the cell is highly 'nonlinear',
while a value of 6 means the cell is 'linear'. Note that if any neigh­
bor of p is empty, we skip the calculation of J(p) and do not apply
the linearity test at p.
6

COMPARISON WITH HALOS AND DISCUSSION

In this section, we examine the performance of the feature extrac­
tors, with their initial thresholds set as described in Section 4. The
threshold can be manipulated independently for each extractor, if
desired. As previously stated, we use a density-based halo finder
as an independent method for locating compact multistreaming re­
gions with a large number of streams. Due to space limitations, we
only show images based on the last frame of the simulation.

Variance

Variance is a measure of the distributional spread of a given set of
numbers. Velocity variance therefore measures the spread of ve­
locities. Since multistreaming regions are characterized as having
different velocities, also referred to as the velocity dispersion, the
velocity variance is intuitively a good measure for finding these re­
gions. Shandarin [16] has also used velocity variance in his anal­
ysis, but our formulation differs slightly from his. We iterate over
particles, while he iterates over flows.
Given n numbers Xl ,x2' ..Xn and a mean /1, the variance (}2 is
defined as (}2 � I,7=1 (xi - /1)2. The CIC weighted velocity at
each grid point is /1. The velocities of the particles inside the 8
cells containing the grid point are represented by Xi' Since we are
interested in the three-dimensional velocity variance, the calcula­
tion is performed for each velocity component separately. The vari­
ance extends to a symmetric covariance matrix where the diagonal
components are the variance of each velocity component. Treating
each component as an independent random variable, the net veloc­
ity variance is simply the sum of the diagonal components. Unlike
the normalized dot product measure described earlier, this measure
captures the variance of both the direction and magnitude of the
velocity field.

. :. ..
'

20

'

Y Axis "

.

..

.

.

.

..

-,160000

'

120000

�'.

.. :.. . : . .... :
,.
.

..
. ..

.

,, � .

'

08709
200000

. ..

'

80000

'

.
J'

.

.��

40000

....

�

450

. .. :
•

•

=

5.6

Linearity Test

Another test for multistreaming is to check if the velocity field is
still linear. This is motivated by the description that the simulations
start out being linear, then transition through a quasi-linear, and
finally to a nonlinear behavior. Detecting changes in the linearity
of the velocity field may be an indicator of multistreaming.
Given a velocity field V, position p, and velocity gradient J,
we can obtain the velocity of a nearby point that is 8p away us­
ing first order approximations, if the field can be linearly approxi­
mated. From the velocity at p, we can obtain the velocities around
it through V(p+ 8p) V(p)+J(p). 8p, where 8p is set to one
of [± 1,0,0], [0,± 1,0], or [0,0,± 1) depending on which neighbor­
ing velocity is desired. To check whether the velocities around p
are linear or nonlinear, we compare the first order approximation
of V(p+ 8p) against the original velocity Vo(p+ 8p) at each of
the 6 orthogonal neighbors. We use the normalized dot product to
see if the directions of two vectors are similar, and use the absolute
value of the difference of their velocity magnitudes to see if their
magnitudes are similar. A vector pair is considered similar if the
normalized dot product is at least 0.90, an angular separation less

250

Figure 4:

Halo Finder output from ParaView (FOF algorithm).

Spheres are placed at the center of halos and their radius and color
are mapped to the number of particles in the halo. The link length (bb)
used is 0.2 (stated as a fraction of the average inter-particle spacing)
along with a minimum (pm in) of 1450 particles per halo. The image
shows the last frame of the simulation, frame 499.

Density
725
6000
4000
2000

Z=O, Frame 499

=

Figure 5: Streamlines and density contours.

The streamlines are

colored by velocity magnitude, the contours by density. The image
shows a sub-volume of the last frame of the simulation, frame 499.

Figure 4 is the output from the Halo Finder filter of Par­
aView [21] applied on the last frame of the simulation. We use
simple colored spheres to identify and distinguish the different re­
gions found by the different extractors. In Figure 5 we show the
relationship between density and velocity fields. In Figures 6 to 11,

53

the glyphs are scaled and colored by the size of the regions that are
detected by their respective extractors.
40

. 7.��·.':

" <; �:

20

5
2 0

Figure 8: Vorticity. Spheres scaled and colored by size of region with

low vorticity. The region size is the number of 1 h-1 Mpc cells.

Figure 6: Velocity Field Gradient Anisotropy. The region size is the

number of 1 h-i Mpc cells. Spheres scaled and colored by size of

region with high velocity field gradient anisotropy overlaid with halos
(See Figure 4) shown as transparent gray spheres.

Velocity Field Gradient Anisotropy. The regions with high,
above threshold, values of the anisotropy estimator are depicted
in Figure 6. We can see that there is very good correspondence
between these regions and high density regions from Figure 4.
Nonetheless, when zoomed in, one can notice smaller regions with
high velocity gradient but insufficiently high density to be detected
by the halo finder. Likewise, there are some high density regions
where the velocity gradients are not as pronounced.

Vorticity. Figure 8 shows regions with high vorticity magni­
tude; there is an excellent correspondence of these regions with the
halos identified in Figure 4. Note that halos have very high stream
counts so one expects high vorticity in a halo region, but vortic­
ity can also be large in less compact regions, e.g., filaments. For a
more quantitative assessment of the halo-vorticity correlation, see
Table 2. Although frames at earlier times are not shown, as time
progresses, the vorticity increases in the overdense regions.

Z=O, Frame 499

� .: :...! : . � �

-........
.. .,-.
. ,...
.,

Divergence.

The results of the divergence extractor are shown
in Figure 7. Comparing these results with Figure 4, we see that the
second-largest halo corresponds to the largest region with highly
negative divergence (sink-like behavior). This indicates that the
halo is very active in recruiting new particles from its surround­
ings and thereby increasing its density. The locations of other re­
gions with negative divergence correspond roughly to where the
other more prominent halos are located. The obvious lack of other
significant regions with negative divergence is evidence that accret­
ing mass flows are dominated by the halo contributions.

....

... c

.
· .
.....#
.. ' .,'
.. . .. :

r

...

�

•

-.

.

..
.

40
20

5
2 0

Figure 9: Dot Product. Spheres scaled and colored by size of re­

•

150

Divergence 200

40

gion with low absolute values of dot product. The region size is the

20

Dot Product. As discussed earlier, we are using normalized
quantities for this extractor because we are primarily searching for
stream-crossing regions. The vast majority of the volume at the fi­
nal time (> 90%) is in single-stream flows [17], so large regions
with low dot product should correspond to rare 'supercluster'-like
configurations (which encompass many halos). The correspon­
dence between the regions with low dot products in Figure 9 and
the density field as sampled by halos in Figure 4 is as expected low density regions should have coordinated flows and hence large
values of this estimator, while high density regions have low dot
products. There is a good correlation between the halo regions and
the regions found by the estimator.

•

---5
2 ' 0" �- 50

Figure 7: Divergence. Spheres scaled and colored by size of region

with negative divergence. The region size is the number of 1 h-1 Mpc
cells.

54

number of 1 h-1 Mpc cells.

Variance. The velocity variance is typically proportional to the
mass of the associated structure; comparing Figure IO to the halo

Halos

Velocity
Gradient

Figure 10: Variance. Spheres scaled and colored by size of region

with high variance. The region size is the number of I h-I Mpc cells.

finder result, we observe that the main structures are similarly lo­
cated, with the four biggest halos co-located with the four biggest
regions with high variance.
Linearity Test. Figure 11 shows results from running the lin­
earity test. We observe that nonlinear flow regions, shown by
spheres, correspond to the halos in Figure 4. The overall structure
of the nonlinear flow regions are consistent with those found with
other methods described earlier.
z=o, Frame 499

•

20

15

Y Axis .'

10

Figure 11:

.'
. . .

•• .

.�

"e '

.

.
. .

•

Linearity test.

.'.,

Spheres scaled and colored by size of

region with high nonlinearity.

h-I Mpc cells.

200

• .
� t' .•

"

The region size is the number of I

Particles, Halos, and Regions. The qualitative visual infor­
mation presented here as a first test of the estimators is encouraging
(See Figure 12). Beyond qualitative agreement, however, it is use­
ful to also consider some preliminary quantitative tests. One should
keep in mind, though, that while overdensity and multistreaming
fields are correlated, they are not identical. Nevertheless, the halos
found by the FOF finder are massive enough that each should pos­
sess a large number of streams and should be found by a velocity
based method - but this is a function of the threshold used. Here we
have fixed the threshold using the perturbation theory criterion and
this threshold need not function in a uniform manner across all es­
timators - note that the halo finder also has its own parameters. We
can study the correlation between halos and multistreaming regions

Figure 12: Combination of halo finder output, vorticity and velocity
gradient extractors. Spheres are scaled by size of a region, or halo
mass, and colored by method.

using the concepts of accuracy and coverage, or alternatively, purity
and completeness. By accuracy we mean how many regions out of
those found by a velocity-based method were also identified by the
halo finder. For example, if method A found ten regions, nine of
which intersected (had common particles) with fifteen halos, then
we say that the accuracy is 9/ 10 (90%). In the same example, if
there are 100 halos in total, then the coverage of this method is only
15/ 100 (15%). So, high accuracy does not guarantee high coverage
and vice versa.
In our particular simulation, at z=O (frame 499) the halo finder
found 5036 halos, and at z=2 (frame 165) it found 12243 halos.
The results for accuracy and coverage are summarized in Table 2.
The two extreme cases are the divergence method which found very
few regions but most of them were halos, and the linearity method
which found a lot of nonlinear regions but only a few of them were
found by the halo finder. It will be interesting to further study how
one can jointly optimize accuracy and convergence as a function of
the analysis parameters, but this is beyond the scope of the present
work.
Because they are local and 'one-pass', the velocity based meth­
ods are faster than the halo finder. On a desktop with a 6 core AMD
phenom II X6 processor and 16GB ram, it takes about 4 minutes to
read a frame and another 17 minutes to find halos using ParaView.
On the other hand, the pre-processing time to convert discrete par­
ticle velocities to a continuous field using CIC took 12.5 minutes.
The different methods took varying times: velocity gradient: 60s;
divergence field: 30s; vorticity: 65s; dot product: 35s; variance:
55s; linearity test: 25s.
7

CONCLUSIONS AND FUTURE WORK

We began this investigation with the question of how to use local
velocity information to detect and characterize multistreaming re­
gions. Given certain hypotheses for the properties of the cosmic
flow field, we formulated different ways to extract multistream­
ing regions, keeping the expected behaviors in mind. The velocity
based estimators all require a threshold value to interpret the nu­
merical result. For this purpose, we implemented a physics-based

55

Z-O, Frame 499
Anisotropic shear
Divergence
Vorticity
Dot Product
Variance
Linearity
Z-2, Frame 165
Anisotropic shear
Divergence
Vorticity
Dot Product
Variance
Linearity

#

Regions Found
6576
616
6770
3060
14652
122189
# Regions Found
9237
3201
11308
3729
8976
31555

#

#

Intersections with halos
1838
529
2082
2368
3053
15240
Intersections with halos
5796
3201
7248
3129
5509
17376

Coverage (%)
36.5
10.5
41.3
60.8
60.6
100.0
Coverage (%)
47.3
26.1
59.2
25.6
45.0
100.0

Accuracy (%)
28.0
86.0
4l .9
77.4
20.8
12.5
Accuracy (%)
62.7
100.0
64.1
83.9
6l .4
55.1

Table 2: Overlaps between multistreaming regions and halos using different velocity based methods.

approach - the breakdown of perturbation theory - as a method to
set (tunable) time-varying thresholds for the different estimators.
To correlate the results against an overdensity finder, we used an
approximately isodensity-based halo finder as implemented in Par­
aView. Our findings indicate that: (i) the different velocity based
methods were successful in finding multistreaming regions and in
providing additional information about the dynamic behavior of
overdense regions; (ii) there is good qualitative correspondence be­
tween the regions found using the velocity based methods and those
found by the halo finder; (iii) not all halos are the same in terms of
their dynamic properties, and that velocity based methods could
be used to classify halo types; (iv) the relationship between multi­
streaming regions and halos (overdense regions, more generally) is
complex.
Further investigations along this line will require optimization
of threshold parameters with respect to accuracy and coverage, pa­
rameters that help specify the correlations between overdense re­
gions and multistreaming regions. These investigations are being
currently undertaken. The visualization-aided approach taken here
does not currently require a very sophisticated approach to visualiz­
ing the results. However, in future we will likely need to incorporate
methods for visualizing higher dimensional spaces.
The combination of density and velocity based methods is an
interesting direction to pursue, e.g. whether a machine learning
approach may yield a superior feature extractor using combined
information. Furthermore, the methods we have explored so far
are based on local information. Some halo finders now use six­
dimensional phase space information to detect subhalos as well
phase-space structures such as pure streams and candidate caus­
tics [14]. In addition, recently developed tessellation-based meth­
ods have shown how to detect multistreaming regions in a global
manner [17, 1]. It will be interesting to compare the results of these
methods against those from local estimators.

[3] E. Chandra. Exploring multistreaming in the universe. Master's thesis,
University of California Santa Cruz,2009.
[4] M. Davis, G. Efstathiou, C. S. Frenk, and S. D. M. White. The evo­
lution of large scale structure in a universe dominated by cold dark
matter.

[5]

Astrophysical Journal,

292:371 -394,May 1 985.

1. Einasto, A. A. Klypin, E. Saar, and S. F. Shandarin. Structure of
superclusters and supercluster formation. iii quantitative study of the
local supercluster.

MNRAS, 206:529558,February

[6] R. Fraedrich, 1. Schneider, and R. Westermann.

1 984.
Exploring the mil­

lennium run - scalable rendering ofJarge-scale cosmological datasets.

IEEE TVCG, pages 1 25 1 - 1 258,2009.
[7]

K. Heitmann,P. Ricker,M. Warren,and S. Habib. Robustness of cos­
mological simulations I: Large scale structure.

Supplement,

Astrophysical Journal

1 60(28),2005.

1. W. Eastwood. Computer simulation using par­
& Francis,Inc.,Bristol,PA,USA, 1 988.

[8] R. W. Hockney and

ticles.

Taylor

[9] A. Klypin, S. Trujillo-Gomez, and J. Primack. Halos and galaxies in
the standard cosmological model: results from the Bolshoi simulation.
http://arxiv.org/abs/l002.3660v4.
[ 1 0] A. Knebe et al. Haloes gone mad: The halo-finder comparison project.

arXiv :1104.0949vl, MNRAS, 415, 2293,August 20 1 1 .
[ 1 1 ] E. Komatsu et al. Seven-year Wilkinson Microwave Anisotropy Probe
(WMAP) Observations: Cosmological Interpretation.

Supp.,

Astrophys. J.

1 92(2): 1 8+,Feb. 20 1 1 .

[ 1 2] H. Li, c.-w. Fu, Y. Li,and A. Hanson. Visualizing large-scale uncer­
tainty in astrophysical data.

IEEE TVCG, 1 3(6): 1 640- 1 647,2007.

[ 1 3] Z. Lukic, D. Reed, S. Habib, and K. Heitmann. The structure of ha­
los: Implications for group and cluster cosmology.

Journal,

The Astrophysical

692( 1 ):2 1 7-228,2009.

[ 1 4] M. Maciejewski,S. Colombi,V. Springel,C. Alard,and F. R. Bouchet.

Monthly No­
tices of the Royal Astronomical Society, 1 96: 1 329- 1 348,2009.
V. Sahni and P. Coles. Approximation methods for non-linear gravita­
tional clustering. Physics Reports, 262: 1 - 1 35,Nov. 1 995.
Phase-space structures II. hierarchical structure finder.

[ 1 5]

[ 1 6] S. Shandarin. The multi-stream flows and the dynamics of the cosmic
web,20 1 0. http://arxiv.orglabs/l0l 1 . 1 924.

ACKNOWLEDGEMENTS

The authors are greateful to Allen Van Gelder for suggesting the
linearity test and the anonymous reviewers for their comments and
suggestions.

http://arxiv.org/abs/III1.3944v2, astro-ph.CO, Novem­

ber 20 1 1 .

1. Carlson,M. White,and N. Padmanabhan. Critical look at cosmolog­
PhYSical Review D, 80(4):04353 1 ,

ical perturbation theory techniques.
Aug 2009.

56

20 1 1 .
[ 1 8] S. F. Shandarin and

http://arxiv.org/abs/II I1.2366, Nov.

Y. B. Zeldovich. The large-scale structure of the

universe: Turbulence, intermittency, structures in a self-gravitating
medium.

Rev. Modern Physics,

6 1 (2): 1 85-220, 1 989.

V. Springel et al. Simulations of the formation,evolution and cluster­

ing of galaxies and quasars.

[ 1 ] T. Abel, O. Hahn, and R. Kaehler. Tracing the dark matter sheet in

[2]

Stream Flows,and Tessellations.

[ 1 9]

REFERENCES
phase space.

[ 1 7] S. Shandarin, S. Habib, and K. Heitmann. The Cosmic Web,Multi­

Nature, 435(7042):629-636,June 2005.

[20] R. von Mises. Mechanik der festen korper im plastisch deformablen
zustand.

Gottin. Nachr. Math. Phys.,

[2 1 ] J. Woodring et al.

lations with ParaView.

Supp., 195, 11,

1 :582-592, 1 9 1 3.

Analyzing and Visualizing Cosmological Simu­

http://arxiv.org/abs/IOIO.6I28, Astrophys. J.

July 20 1 0.

