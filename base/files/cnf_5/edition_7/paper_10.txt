On the Design of Optimal Derivative Filters for Coherence-Enhancing
Diffusion Filtering
Wang Wenyuan
Institute of Applied Physics and Computational Mathematics,
P.O. Box 8009-16,Beijing 100088,P.R.China
wang_wenyuan@iapcm.ac.cn

Abstract
For strongly oriented anisotropic processes such as
coherence-enhancing diffusion filtering it is crucial to use
numerical schemes with highly accurate directional
behavior. It is not possible in a satisfactory way when
discretizations are limited to 3×3 stencils. We can expand
discretization stencils in the first-order derivative filters
scheme [15]. In 2d or 3d images, the directional behavior
is correlated with first-order derivative filter. In the paper
new optimized 3-tap and 5-tap pair of first-order derivative
filters with rotation-equivariant are designed in
anisotropic diffusion for images with different spatial
frequencies. We demonstrate the new implements have
better behavior with respect to the following properties:
rotation invariance, avoidance of blurring artifacts
(dissipation), and more efficient.

1. Introduction
In this paper we evaluate behaviors of new optimally
rotation-equivariant directional derivative kernels applied
in coherence-enhancing diffusion filtering. This scalespace and image restoration technique has been introduced
in [10] for the enhancement of textures with line-like
structures.
Since coherence-enhancing anisotropic diffusion
filtering is essentially a one-dimensional smoothing
strategy in a multidimensional image, it is of outmost
importance to have a precise realization of the desired
smoothing direction. When the goal consists e.g. of closing
gaps in an interrupted line-like structure, it is clear that
slight deviations from the correct smoothing direction will
destroy any desired filter effect and result in a deterioration
of the line by introducing blurring artifacts. This direction
sensitivity constitutes an additional problem for the design
of appropriate algorithms for diffusion filtering that has
been first addressed in [15]. In that paper J.Weickert and

H.Scharr introduce a scheme that is designed to handle this
difficulty. Its main ingredient is the consequent use of
specific first-order derivative filters that have been
optimized with respect to rotation invariance .
In this paper we extend the J.Weickert’ s scheme with
better rotation-equivariant and more flexible first-order
derivative filters. We design the filters basing on the theory
of Simoncelli’ s filters [9, 3]. There are two distinctive
aspects of these filters. First, instead of designing a single
derivative filter, both the smoothing and the derivative
filters are designed simultaneously. It guarantees the filters
have extremely good behavior of rotation-equivariant.
Second, the error function adopts a reasonable weighting
function over frequency. For applications in which the
signals to be differentiated are known to occupy a
particular range of spatial frequencies, it can improve
differentiation accuracy over this range. Furthermore, we
apply not only 3×3 but also 5×5 convolution masks as
first-order derivative in this paper. Because only applying
3× 3 convolution masks as first-order derivative just as
introduced in [15], can not show the accurate
rotation-equivariant for the high spatial frequencies (above
0.5 cycles/pixel). We shall see that applying the new
designing filters creates less blurring artifacts, and is more
accurate, and has higher efficiency.
The paper is organized as follows. In Section 2 we
sketch the concept of coherence-enhancing diffusion
filtering, and review one-first derivative filter scheme. In
Section 3 we present the novel optimally rotationequivariant derivative filters. In Section 4 we evaluate
performance of different filtering implements. We evaluate
rotation invariance, dissipative effects resulting in blurring
artifacts, and efficiency. Finally we conclude with a
summary in Section 5.

2. Coherence-enhancing anisotropic diffusion
2.1. General filter structure

Proceedings of the International Conference on Computer Graphics, Imaging and Visualization (CGIV’04)
0-7695-2178-9/04 $20.00 © 2004 IEEE

Coherence-enhancing anisotropic diffusion filtering
with a diffusion tensor evolves the initial image under an
evolution equation of type
∂u
 a b
= ∇ ⋅ ( D∇u ) , D = 

∂t
b c

(1)

where u ( x, t ) is the evolving image, t denotes the
diffusion time, and D is the diffusion tensor, a positive
definite symmetric matrix that is adapted to the local image
structure. This structure is measured by the structure
tensor
J
J ρ (∇uσ ) = Gρ ∗ (∇uσ ∇uσT ) =  11
 J12

J12 

J 22 

(2)

The function G ρ denotes a Gaussian with standard

The resulting so-called standard scheme allows to calculate
all values at a new time level directly from the ones in the
previous level without solving linear or nonlinear systems
of equations.
The standard scheme is showed that its rotation
invariance is not very good in certain situation, in order to
address this problem the scheme with first-order derivative
filter with optimal rotation-equivariant is presented [15].
We rewrite the divergence operator in Eq. (1) as
∇ ⋅ ( D ∇ u ) = ∂ x ( a ∂ x u + b ∂ y u ) + ∂ y ( b∂ x u + a ∂ y u )

This expression is now evaluated in an explicit way, i.e.
using only known values form the old time level. A pair of
first-order derivative filters (p = ( 3 10 3)/16, d = ( -1 0 1 )
/2 ,which have shown with good rotation invariance in
[8,4]) give the optimized derivative filters along axises
Fx = p T ∗ d

deviation ρ, and uσ := G ρ ∗ u is a regularized version of

u that is obtained by convolution with a Gaussian Gσ .
The

eigenvectors

of

J ρ give the preferred local
orientations, and the corresponding eigenvalues denote the
local contrast along these directions. The structure tensor is
highly robust under isotropic additive Gaussian noise[5].
The eigenvalues µ1 ≥ µ 2 of J ρ are evaluated and the

normalized first eigenvector can be written as
(cosα , sin α )T . The diffusion tensor D of coherenceenhancing anisotropic diffusion uses the same eigenvectors
as the structure tensor, and its eigenvalues are assembled
via
c1
λ1 := c1 , λ 2 := 
c1 + (1 − c1 ) exp

(

− c2

( µ1 − µ 2 ) 2

)

if µ1 = µ 2
else

(3)

where c1 ∈ (0,1), c2 > 0 . The condition number of D is
thus bounded by 1 / c1 , and the entries of D are
a = λ1 cos 2 α + λ 2 sin 2 α
b = (λ1 − λ 2 ) sin α cos α

(4)

c = λ1 sin 2 α + λ 2 cos 2 α

For more details on coherence-enhancing anisotropic
diffusion we refer to [14].

2.2. standard scheme and first-order derivative
filters scheme
Equation (1) can be solved numerically using finite
differences[11]. Spatial derivatives are usually replaced by
central differences, while the easiest way to discretize
∂u consists of using a forward difference approximation.
∂t

(5)

and

Fy = FxT

(6)

where T is transpose operate.
For the scheme of the first-order derivative filters, There
are five steps to proceed: 1. Calculate the structure tensor
using the optimized derivative filters from Eq. (5); 2.
Assemble the diffusion tensor as a function of the structure
tensor; 3. Calculate the components j1 := a∂ x u + b∂ y u and

j2 := b∂ xu + c∂ y u with the optimized filters; 4. Calculate
∇ ⋅ ( D∇u ) = ∂ x j1 + ∂ y j2 by means of the optimized
derivative filters; 5. Update in an explicit way.

3. Designing the new optimally first-order
derivative filters
In this section we design new optimally first-order
derivative filters with better rotation-equivariant and more
flexibility than ones in the section 2.2. Let us assume that
the required derivative filter is a linear phase Finite
Impulse Response (FIR) filter with an odd number of taps.
The general form of the filter’s impulse response is given
by:
{d ( k )}nL= − L = [d L

L d2

d1

− d2 L dn ]

0 − d1

Taking the Fourier transform on d (k ) yields the
following transfer function:
D (ω ) =

L

L

k =− L

n =1

∑ d (n) exp {− jn ω } = 2 j ∑ d

n

sin(ω n )

(7)

The goal is to obtain a near-accurate first-order
derivative transfer function D (ω ) = jω . The filter
coefficients {d (n)}nL=1 are designed to meet this

Proceedings of the International Conference on Computer Graphics, Imaging and Visualization (CGIV’04)
0-7695-2178-9/04 $20.00 © 2004 IEEE

requirement as closely as possible.
We design the new optimally first-order derivative
filters for anisotropic diffusion filtering include two
important issues: 1. Design of pairs of filters, both the
smoothing and the derivative filters are designed
simultaneously. This means that a signal I(x) and its
derivative I x (x) are hard to come-by accurately in the

for 5-tap pair of filters, ω 0 is the maximal spatial
frequency of image (in this paper, we select
ω 0 = 0.8cycles / pixel ). Now we can get the new Optimally

discrete domain. Alternatively, we can supply a pair
{I ∗ p}( x) and {I ∗ d }( x) which relate to each other as an
original and its derivative in a more accurate form. If we
denote a smoothing and a derivating 1-D filter pair in the
frequency domain by P (ω ) and D (ω ) respectively, then
the error [ jωP(ω ) − D (ω )] can be minimized in a more
accurate manner. For example, high frequencies which are
not treated correctly by D (ω ) are attenuated by P (ω ) in
order to minimized the above approximation. 2. Weighting
the approximation error. Since the required filters are
designed to work on natural images, it is reasonable to
weight the approximation error with accordingly weight
function w(ω ) .

3-tap: p 0.182166 0.635668 0.182166

With the above considerations, the Weighted Least
Squares (WLS) criteria for the filter design is

∈

2

∫
( p, d ) =

π

−π

w(ω )[ jωP(ω ) − D(ω )] dω
2

∫

π

−π

(8)

P 2 (ω )dω

This error function is in the form of a Rayleigh quotient,
and thus the solution may be found using standard
techniques, the Singular Value Decomposition (SVD). The
resulting filters are normalized so that p (n) yields a unity
DC response. The result is a pair of 1-D filters: the
smoothing filter p (n) , and the derivative filter d (n) .
The filter p ( n) ∗ d ( n) can be called rotation-equivariant
derivative filter, which is showed with good rotation
invariance[9, 3].
The spatial frequencies of image are the important issue
to design the appropriate optimal first-order derivative
filters with rotation invariance for coherence-enhancing
diffusion processes. In general, if the image’ s spatial
frequencies range lower 0.5cycles/pixel, 3-tap pair of
filters will be acquired adequately accurate processes with
rotation invariance; if spatial frequencies range above
0.5cycles/pixel, 3-tap pair of filters can not act good, we
should select 5-tap pair of filters to get good behavior of
rotation invariance. We choose the weighting function as
1 ω ≤ ω 0
w(ω ) = 
0 ω > ω 0

first-order Derivative filters from error function. The
resulting filter values for a 3-tap and 5-tap filter pair are
given in figure 1.

d 0.495770 0.000000 -0.495770
5-tap: p 0.018341 0.235337 0.492644

0.235337

0.018341

d 0.070941 0.358105 0.000000

-0.358105

-0.070941

Figure 1. Matched pairs of prefilter (p) and derivative (d) kernels
for a 3-tap and 5-tap.

Shown in Figure 2 is the frequency response of several
first-order derivative filters and the product of an
imaginary ramp and the frequency response of their
associated prefilters. If the filters were perfectly matched,
as design criteria, then these responses should be identical.
Shown are the responses from the new optimally designed
3- and 5-tap filters. For comparison, we show the responses
of differentiators: a standard (binomial) 2-tap (p = ( 1 1 )
/2, d = (-1 1 )/2), 3-tap in section 2.2 (p = ( 3 10 3)/16, d
= ( -1 0 1 ) /2).
Note that the standard 2-tap derivative will be
underestimated for low frequencies and overestimated for
high frequencies. The standard explicit scheme has the
same precision as standard 2-tap derivative filter applied in
first-order derivative filter scheme. Weickert 3-tap
derivative show the good identical responses on the spatial
frequencies below about 0.4 cycles/pixel. New optimally
designed 3- and 5-tap derivatives show very good identical
responses on the spatial frequencies below about 0.5 and
0.8 cycles/pixel respectively.
Above the new first derivative operators p ( n) ∗ d ( n)
can be used in the first-order derivative filter scheme
(section 2.2) for coherence-enhancing diffusion filtering.
Since the resulting scheme makes consequent use of the
derivative filters with better optimized rotation invariance,
we may expect better directional behavior. It should be
noted that the total stencil of this scheme has size 5×5 or
9×9, if we are approaching the second order derivatives by
consecutively applying first order derivatives of size 3×3
or 5×5, and However, there is no need to write down a
complicated 5×5 or 9×9 stencil, since they are nowhere
required in the entire algorithm.

4. Performance Evaluation
(9)

where for 3-tap pair of filters, ω 0 = 0.5cycles / pixel ,

In this section we shall juxtapose our new first
derivative operators applied in the first-order derivative
filter scheme for coherence-enhancing diffusion filtering

Proceedings of the International Conference on Computer Graphics, Imaging and Visualization (CGIV’04)
0-7695-2178-9/04 $20.00 © 2004 IEEE

with existing ones in order to evaluate their performance.
We focus on investigating rotation invariance, dissipative
effects creating blurring artifacts and efficiency.

4.1. Rotation invariance and dissipativity
Test computations were performed on a ring image with
varying frequencies (see Figure 3(a)). The maximum
spatial frequency is 0.8 cycles/pixel. We apply for different
explicit schemes for coherence-enhancing diffusion: the
standard scheme, Weickert 3-tap derivative filter scheme,
and our novel optimal 3-tap and 5-tap derivative filters. As
parameters we use c1 := 0.001, c2 := 1, σ = 0.1, ρ = 5,
τ = 0.24 and we apply 150 iterations.
Applying coherence enhancing anisotropic diffusion to
this ring image should not deteriorate the rotation
invariance, and it should hardly alter this image (only by
some small isotropic diffusion caused by the parameter
c1 ). Figure 4 shows the results. One observes that the
standard discretization introduces severe blurring artifacts
for all directions except for the directions of the coordinate
axes. This is caused by incorrect directional behavior and
undesired damping of high frequencies, as can be seen if
the transfer function for specific choices of λ1 , λ2 and α
are examined. If the diffusion does not exactly follow the
circles, it immediately blurs them. For the Weickert 3-tap
derivative filter scheme and the new 3-tap derivative filter
scheme, dissipative effects or deviations from rotational
invariance cannot be observed at much of region, but at the
region with high spatial frequencies, blurring artifacts still
exist. For the new 5-tap derivative filter scheme very little
dissipative effects can be observed, the result is visually
indistinguishable from the original image.
To demonstrate the importance of rotation invariance,
we use our four implementations for reducing Gaussian
noise that has been added to the test image ( Figure 3(b)).
The Gaussian noise has zero mean, and the standard
deviation has the 0.05 times as the magnitude the signal
amplitude. Figure 5 shows the results using the same filter
parameters as before. Only the new 5-tap derivative filter
scheme reconstructs the signal satisfactory for all
orientations and frequencies. For the standard scheme the
signal information is so weak that the directional errors of
the discretization dominate for high frequencies. For the
Weickert 3-tap derivative filter scheme and the new 3-tap
derivative filter scheme, the information is some weak for
the signal with high frequencies, and the latter shows a
little better than the former.
Smoothing effects result in loss of fine structures in the
depicted ring images (Figure 3). For orientations parallel to
the coordinate axes, all discretizations preserve the signal.
Blurring artifacts therefore might be a directional failure
only, with less effect for real data. In order to demonstrate

that this error should not be neglected we applied the three
algorithms to van Goghs "Road with Cypress and Star"
(Auvers-sur-Oise,
1890;
Otterlo,
Rijksmuseum
Kröller-Müller). This test image has been used in [14] for
evaluating coherence-enhancing diffusion filtering. The
general impression from Figure 6 is that the new 5-tap
derivative filter scheme produces the sharpest and most
detailed results.

4.2. Efficiency and stability
Let us now evaluate the efficiency of different filtering
implements. The total efficiency of an iterative method is
the product of the computational cost for one iteration and
the number of iterations that are required for reaching a
fixed diffusion time T. The latter depends on the largest
time step size under which the scheme is stable.
Unfortunately, no theoretical stability bounds are available,
since neither the von Neumann stability using the Fourier
transform nor stability reasonings based on maximumminimum principles can be applied.
Therefore, we have to perform experimental stability
measurements. As a stability criterion we use the temporal
evolution of the variance of the filtered image, which has
to decrease monotonically [11]. Thus, if the variance is
increased from one step to the next, it is a clear sign of
instabilities. As an upper estimate for an experimentally
stable behaviour we have searched for the largest time step
size for which the variance decreases monotonically.
The results of our efficiency analysis are depicted in
Table 1. Stability bounds may be overestimated as
instabilities may arise before the monotony of the variance
is violated. To be on the safe side we recommend to use
time step size 0.25 for the explicit standard, step size 1 for
the 3-tap derivative filters scheme, and size 1.7 for the
5-tap derivative filters scheme. This shows that the 5-tap
derivative filters scheme is the most efficient one.
Table1. Efficiency of the different methods on a PC (Pentium IV,
2GeHz). All algorithm were implemented in a comparable way using
ANSI C, and we used the same image and filter parameters as in Figure
6.
stability recommended Efficiency
DiscretitCPU
per
bound
zation
τ/tCPU
step size τ
iteration
τmax
[s-1]
standard 0.0575s
0.5
0.25
4.349
scheme
Weickert 0.0687s
2.1
1.0
14.56
3-tap
new
0.0687s
2.0
1.0
14.56
3-tap
new
0.0701s
3.5
1.7
24.25
5-tap

5. Summary and Conclusions

Proceedings of the International Conference on Computer Graphics, Imaging and Visualization (CGIV’04)
0-7695-2178-9/04 $20.00 © 2004 IEEE

In the paper we have introduced new 3-tap and 5-tap
pair of first-order derivative filters applied in anisotropic
diffusion filtering. The new derivative filters has better
optimized rotation invariance than existing. In a detailed
evaluation with different schemes we have shown that the
3-tap pair of first-order derivative filters scheme has good
directional performance for image with spatial frequencies
below 0.5 cycles/pixel, the 5-tap pair of first-order
derivative filters scheme has superior directional
performance for image with high spatial frequencies while
the 3-tap filters can not act good. This point is very
important for anisotropic diffusion techniques, since
directional errors introduce visible smoothing artifacts
(dissipative effects) and large numerical errors. At the
same time the 5-tap derivative filters scheme is more
efficient than others. These performance characteristics
render that, to combine good quality with high efficiency
in anisotropic diffusion filtering, we can select the proper
filters scheme for different images with corresponding
maximal spatial frequency.

[11] J. Weickert, Anisotropic diffusion in image processing,
Teubner, Stuttgart, 1998.
[12] J. Weickert, Coherence-enhancing diffusion filtering , Int.
J. Comput. Vision, Vol. 31, 111-127, 1999.
[13] J. Weickert, B.M.ter Haar Romeny, A. Lopez, W.J. van Enk,
Orientation analysis by coherence-enhancing diffusion , Proc.
Symp. Real World Computing (RWC '97, Tokyo, Jan. 29-31,
1997), 96-103, 1997.
[14] J. Weickert, B.M. ter Haar Romeny, M.A. Viergever,
Efficient and reliable schemes for nonlinear diffusion filtering ,
IEEE Trans. Image Proc., Vol. 7, 398-410, 1998. 20
[15] J.Weickert, A scheme for Coherence-Enhancing Diffusion
Filtering with Optimized Rotation Invariance , Journal of Visual
Communication and Image Representation, Vol. 13, No. 1/2,
103-118, March/June 2002.

References
[1] L. Alvarez, F. Guichard, P.-L. Lions, J.-M. Morel,
Axioms
and fundamental equations in image processing , Arch. Rational
Mech. Anal., Vol. 123, 199-257, 1993.
[2] L. Alvarez, P.-L. Lions, J.-M. Morel,
Image selective
smoothing and edge detection by nonlinear diffusion. II , SIAM J.
Numer. Anal., Vol. 29, 845-866, 1992.
[3] Hany Farid, Eero P.Simoncelli,
Differentiation of Discrete
Multi-Dimensional Signals
, IEEE Transctions on Image
Processing, 2003
[4] B. Jähne, H. Scharr, S. Körkel, “Principles of filter design , B.
Jähne, H. Haußecker, P. Geißler (Eds.), Handbook on Computer
Vision and Applications, Vol. 2: Signal Processing and Pattern
Recognition, Academic Press, San Diego, 125-152, 1999. 18
[5] M. Kass, A. Witkin, “Analyzing oriented patterns , Computer
Vision, Graphics, and Image Processing, Vol. 37, 362-385, 1987.
[6] P. Perona, J. Malik, Scale space and edge detection using
anisotropic diffusion , IEEE Trans. Pattern Anal. Mach. Intell.,
Vol. 12, 629-639, 1990.
[7] A.R. Rao, B.G. Schunck, “Computing oriented texture fields ,
CVGIP: Graphical Models and Image Processing, Vol. 53,
157-185, 1991.
Numerische Isotropieop[8] H. Scharr, S. Körkel, B. Jähne,
timierung von FIR-Filtern mittels Querglättung , E. Paulus, F.M.
Vahl (Eds.), Mustererkennung 97, 367-374, Braunschweig,
Springer, September, 1997.
[9] E. P. Simoncelli,
Design of multi-dimensional derivative
filters , in First International Conference on Image Proc., vol. I.
Austin, Texas: IEEE Sig Proc Society, November 1994, pp.
790–793.
[10] J. Weickert, Multiscale texture enhancement , V. Hlaváè,
R.Šára (Eds.), Computer analysis of images and patterns, Lecture
Notes in Computer Science, Vol. 970, Springer, Berlin, 230-237,
1995.

Figure 2. First order derivative : Fourier magnitude, plotted for –1
to 1 cycles/pixel. The thin line corresponds to the product of a ramp
and prefilter, and thick line corresponds to the derivative filter

Figure 3. Test image: a original, b with Gaussian nose

Proceedings of the International Conference on Computer Graphics, Imaging and Visualization (CGIV’04)
0-7695-2178-9/04 $20.00 © 2004 IEEE

Figure 4. Rotation invariance and dissipativity test: original ring image after applying four schemes
for coherence-enhancing diffusion filtering.

Figure 5. Reconstruction properties for the noisy ring image form Figure 3(b)

Figure 6. Dissipativity illustrated by means of van Goghs “ Road with Cypress and Star” . The filter parameters are c1 := 0.001, c2 := 1, σ = 0.1,
ρ = 5, τ = 0.24 . In order to make the different better visible, 100 iterations have been applied.

Proceedings of the International Conference on Computer Graphics, Imaging and Visualization (CGIV’04)
0-7695-2178-9/04 $20.00 © 2004 IEEE

