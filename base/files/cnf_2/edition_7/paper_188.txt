Pacific Graphics 2009
S. Lee, D. Lischinski, and Y. Yu
(Guest Editors)

Volume 28 (2009), Number 7

Gradient-Preserving Color Transfer
Xuezhong Xiao1 and Lizhuang Ma1
1 Department

of Computer Science & Engineering, Shanghai Jiao Tong University, China

Abstract
Color transfer is an image processing technique which can produce a new image combining one source image’s
contents with another image’s color style. While being able to produce convincing results, however, Reinhard et
al.’s pioneering work has two problems—mixing up of colors in different regions and the fidelity problem. Many
local color transfer algorithms have been proposed to resolve the first problem, but the second problem was paid
few attentions.
In this paper, a novel color transfer algorithm is presented to resolve the fidelity problem of color transfer in
terms of scene details and colors. It’s well known that human visual system is more sensitive to local intensity
differences than to intensity itself. We thus consider that preserving the color gradient is necessary for scene
fidelity. We formulate the color transfer problem as an optimization problem and solve it in two steps—histogram
matching and a gradient-preserving optimization. Following the idea of the fidelity in terms of color and gradient,
we also propose a metric for objectively evaluating the performance of example-based color transfer algorithms.
The experimental results show the validity and high fidelity of our algorithm and that it can be used to deal with
local color transfer.
Categories and Subject Descriptors (according to ACM CCS): I.3.3 [Image Processing and Computer Vision]: Transform methods—

1. Introduction
Color transfer is an image processing technique which conveys the color characteristics of a reference image to a source
image. Ideally, the result by a color transfer algorithm should
keep the scene from the source image and apply the color
style of the reference image. A good color transfer algorithm
should provide fidelity both in terms of scene details and colors.
Reinhard et al. [RAGS01] originally presented a simple
and efficient color transfer algorithm which translates and
scales an image pixel-by-pixel in lαβ color space according
to the mean and standard deviation of the color values in
the source and reference images. While this produces convincing results, this approach still has two problems. Firstly,
it can produce unnatural looking results in cases where the
source and reference images have different color distributions. Secondly, as the algorithm is based on simple statistics (mean and standard deviation), it can produce results
with low fidelity in scene details and color distribution (Figure 1, 2). The first problem is widely known and many algoc 2009 The Author(s)
Journal compilation c 2009 The Eurographics Association and Blackwell Publishing Ltd.
Published by Blackwell Publishing, 9600 Garsington Road, Oxford OX4 2DQ, UK and
350 Main Street, Malden, MA 02148, USA.

rithms have been proposed to resolve it, e.g. swatch-based
methods [RAGS01, WAM02], Chang et al.’s perceptual
color category-based algorithm [CSN03,CSN07], EM-based
soft color segmentation approach [TJT05, TJT07], Gaussian
probability weighted color transfer method [WHCO08]. A
main contribution of this paper is a solution to the second
problem, which could be used with such techniques.

In this paper, we focus on fidelity of color transfer: the
extent to which the produced result accurately reproduces
the scene in the source image and the color distribution of
the reference image. Pitie et al.’s method of n-dimensional
probability density function (pdf) matching carries out the
fidelity of color distribution, but it produces extra edges (Figure 1(d)). It is well known that the human visual system is
more sensitive to local intensity differences than to intensity itself [LM71, Wer35]. We thus consider that preserving
the color gradient is necessary to scene fidelity. We use a histogram to assess color. Combining gradients and a histogram
gives a basis for a gradient-preserving color transfer algo-

Xuezhong Xiao & Lizhuang Ma / Gradient-Preserving Color Transfer

1880

(a)

(b)

(c)

(d)

(e)

Figure 1: Comparison among color transfer algorithms (Example #1): (a) a source image; (b) a reference image; (c) the result
by Reinhard et al.’s algorithm; (d) the result by Pitie et al.’s method; (e) the result by our algorithm. Note that the color of the
flowerpot in (c) is out of the color range of the reference image (b) and the extra details in (d) is not in the source image (a).

rithm and an objective evaluation metric for example-based
color transfer.
In summary, this paper makes the following contributions:
(i) a gradient-preserving color transfer algorithm which can
integrate more accurately the two key components of color
transfer—we attempt to preserve the source image’s color
gradient and the reference image’s color style, and (ii) a simple and effective metric to measure fidelity in terms of gradient and color.
2. Related Work
Recently, color transfer has become a fruitful research topic.
We may classify these color transfer methods into global and
local algorithms.
Reinhard et al.’s pioneering work [RAGS01] presented a
global algorithm for transferring one image’s color style to
another. Just as what they found, the performance of color
transfer is impacted by the source and reference images’
similarity in composition. Reinhard et al. proposed a local
method based on the inverse distance weighting to remedy
it. After that, several local approaches were devised to make
up the deficiency.
Chang et al. proposed a color category-based color transfer algorithm [CSN03] and extended it to process video
data [CSN07]. Firstly, they converted the source and reference images to CIE L∗ a∗ b∗ color space and categorized

each pixel as one of the eleven basic categories. Then, a
convex hull was generated in color space for each category
of pixel point set. Finally, color transformation was applied
within each pair of convex hull of the same category.
Tai et al.’s local color transfer approach was based on their
soft color segmentation algorithm [TJT05, TJT07]. Firstly,
a modified EM algorithm was proposed to segment probabilistically the input images and construct GMMs (Gaussian
Mixture Models) for them. Then, the corresponding relationships were obtained to map each Gaussian component in the
source image to some Gaussian in the reference image. Finally, Reinhard et al.’s method was applied on each Gaussian
component pairs and the intermediate results were combined
fractionally according to each pixel’s probability.
Wen et al. proposed a system for image enhancement by
using a new color transfer algorithm [WHCO08]. The system provided users with a stroke-based user interface for
specifying the unchanged background and the corresponding
regions on the source and reference images. Firstly, an improved Graph-Cut algorithm was employed to segment the
background. Then, a Gaussian probability weighted color
transfer algorithm was presented to transform the source image according to the relevant strokes. But the direct algorithm can result in artifacts. So the authors used a gradientbased smoothness term to improve it.
Welsh et al. extended the idea of color transfer to colorize
gray-scale images [WAM02]. Their algorithm computes the
c 2009 The Author(s)
Journal compilation c 2009 The Eurographics Association and Blackwell Publishing Ltd.

Xuezhong Xiao & Lizhuang Ma / Gradient-Preserving Color Transfer

chromatic values of a pixel through a luminance matching guided by the statistics within the pixels’ neighborhood.
Rectangular swatches are used to achieve local matching.
In summary, aforementioned local methods basically rely
on their classification schemes to successfully produce good
results, e.g. Chang et al.’s eleven basic categories, Tai et al’s
soft color segmentation, wen et al.’s Gaussian probability
weighting. We believe that these classification schemes can
be combined with global color transfer algorithms to achieve
local color transfer. Therefore, we mainly focus on global
processing in this paper.
Pitie et al. [PKD05] presented a general n-dimensional
pdf transfer method through the iteration of rotation of axis
following several one-dimensional marginal matching and
proved its convergence. The n-dimensional pdf transfer algorithm can be utilized to globally transfer colors between
images. It obviously guarantees the preservation of color distribution. But unfortunately, it is easy to stretch excessively
pixel values and results in the change of content (see Figure 1(d)). So, Pitie et al. proposed a softening scheme to
remedy it.
Our algorithm is derived from the idea of fidelity in terms
of gradient and color. In a sense, our method belongs to the
domain of gradient manipulation which has recently become
a very popular and hot research topic [AR07]. The techniques are widely used in many applications including HDR
(High Dynamic Range) compression [FLW02, MMS06], local adjustment of tone [LFUS06], multi-scale decomposition
of images [FFLS08], non-photorealistic rendering [MP08],
etc.
Evaluation metrics are very important for evaluating algorithms’ performance. PSNR (Peak Signal-to-Noise Ratio)
and MSE (Mean Squared Error) are the most popular metrics because of their simplicity in understanding and implementation [WM08]. We proposed a metric for the objective
evaluation of global color transfer algorithms following the
idea of MSE. Compared with Xiang et al.’s [XZL09], our
metric is more appropriate for example-based color transfer
because the colorfulness similarity metric in Xiang et al.’s
method is for the purpose of quality measurement instead of
fidelity [HS03].
3. Gradient-Preserving Color Transfer
Our gradient-preserving color transfer algorithm is now explained. Color transfer has two goals: retaining the elements
of the original scene in their correct color relationships,
while applying the desired color style. To do so, our approach makes a compromise between retaining color gradient information from the source image, and applying the
colors from the reference image. To achieve a perceptually
plausible result, we take the preservation of a source image’s
gradient map and a reference image’s histogram as our target. Thus, we formulate the color transfer problem as an
c 2009 The Author(s)
Journal compilation c 2009 The Eurographics Association and Blackwell Publishing Ltd.

1881

optimization problem which minimizes the following cost
function in terms of least-squared error:

∑ [Hk (o) − Hk (r)]2 + λ ∑

∇s p − ∇o p

2

(1)

p

k

while o, r and s represent the output image, the reference image and the source image respectively; H(·) denotes a color
histogram of the relevant image; ∇ is a gradient operator;
λ is a coefficient for weighting the importance of gradient
preservation and new colors, usually λ = 1. The first sum
is taken over histogram bins, the second sum is taken over
pixels in each image.
Equation 1 is hard to solve because the function H(·) is
a statistical operation acting on the image as a whole while
the gradient operator is applied to each pixel in an image.
Therefore, we split the optimization into two steps and solve
two consecutive tasks. In the first step, a histogram matching
algorithm is employed to convert the source image s into
an intermediate image f which now has exactly the same
color style as the reference image g. Then, the optimization
equation (Eq. 1) can be rewritten as

∑ (oi − fi )2 + λ ∑
i

j

∂o j ∂s j
−
∂x
∂x

2

+

∂o j ∂s j
−
∂y
∂y

2

(2)
which means the output image o is expected to preserve the
color of the intermediate image f and the gradient of the
source image s. The two sums are taken over pixels in the
relevant images.
Equation 2 is rewritten again by using matrix notation,
and then the minimization problem can be defined as the solution of the following linear system:
I + λ(DTx Dx + DTy Dy ) o = f + λ(DTx Dx + DTy Dy )s (3)
while Dx and Dy denote the matrix form of gradient operator
along the x and y axis, respectively. In our implementation,
Dx and Dy are forward Sobel difference operators; DTx and
DTy are backward Sobel difference operators.
Equation 3 is a huge scale linear system of equations.
Although the coefficient matrix is sparse, solving such linear system could consume a great deal of memory and
CPU time. Researchers have presented many solutions to the
problem. Among them, a quadtree-based technique [Aga07]
and a multigrid method [BFGS03] fit our uses because the
former can decrease the scale of the problem and the latter
increases the efficiency of computation.
4. Evaluation Metric
There are few objective metrics proposed for evaluating
the performance of color transfer algorithms. Xiang et
al. [XZL09] combined Hasler and Susstrunk’s
¨
colorfulness
similarity metric [HS03] with Chen et al.’s gradient-based
structural similarity metric [CYX06] to measure the performance of color transfer algorithms. Howbeit, Hasler and

Xuezhong Xiao & Lizhuang Ma / Gradient-Preserving Color Transfer

1882

Susstrunk
¨
have proclaimed in their paper that their method
measures quality but not fidelity [HS03]. That is, the colorfulness metric is designed to evaluate the overall colorfulness of an image rather than to measure the difference between two images. So Xiang et al.’s metric is not suitable to
our application (i.e. example-based color transfer).
We consider that the scene details in the source image and
the color style of the reference image are the two key components in the processing of example-based color transfer.
Therefore, we propose a metric in terms of gradient and histogram to measure the performance of example-based color
transfer algorithms. Following the idea of MSE, we define
the metric as follows,

our approach keep the house clear through the method of
gradient-preserving.
We also use our metric (Eq. 4) to measure the errors of the
results by the three algorithms. The line charts in Figure 3 illustrate the comparison of performance in MSE. MSE assess
synthetically the fidelity of algorithms in terms of gradient
and color distribution, and our algorithm has the best and
stable performance in the objective evaluation metric MSE.

MSE = MSEhist + λ · MSEgrad
=

1
M

+ λ·

M

∑ [Hk (o) − Hk (r)]2

k=1

1
N

N

∑

G(o j ) − G(s j )

2

(4)

j=1

while M is the number of the bins of a histogram; N is the
total number of pixels in an image; λ is a weighting coefficient and we set λ = 1 to represent the equivalent importance
between color and gradient; H(·) and G(·) denote the color
histogram and gradient map of the relevant image, respectively. Here, we compute the gradient maps of color images
by using Di Zenzo’s algorithm [Zen86]. The values of MSE
vary inversely with fidelity.
5. Experimental Results
In this section, we show the results produced by our algorithm and compare our method with previous algorithms.
The experimental environment involves a computer with a
3GHz CPU of Intel Core 2 Duo and 4GB memory, 32-bit
Windows operating system, and Matlab version 7.7. The experiments show that our algorithm has lower computation
efficiency. But our method focuses on the fidelity in terms of
gradient map and color distribution.
Our gradient-preserving color transfer algorithm is an
example-based global method. So we compared it with Reinhard et al’s algorithm [RAGS01] and Pitie et al.’s histogram
matching method [PKD05]. Figure 1 and 2 show several examples (Example #1 – #4) of the comparison among the
three color transfer algorithms. From the figures, we can find
that Reinhard et al.’s algorithm might produce colors which
are out of the color range of the reference images (see the
flowerpot in Figure 1(c) and the red leaves of Example #4
in Figure 2(d)). While Pitie et al.’s approach have the effects of image enhancement, it produces more extra details
from the view of fidelity and sometimes its result looks like
noised (Example #3 in Figure 2(c)). Furthermore, we can
find that the results of Reinhard et al’s and Pitie et al.’s algorithms lose the details of the house in Example #3, but

Figure 3: Evaluation metric in terms of color and gradient.

Figure 4 exhibits the different results corresponding to
different coefficients λ in Equation 3. Obviously, the result
is failed while λ = 10. We find that the value of MSE in
Equation 4 varies following the variation of λ and the minimal values are usually located near 1 for the examples in this
paper. Thus, we normally set λ = 1 for our experiments.
Utilizing previous local methods mentioned in Section 2
to compute the corresponding regions in the source and reference images, our approach can deal with local conditions.
Also, the corresponding relationship can be specified by
users. Figure 5 shows two examples of our algorithm in local color transfer. Users edited the masks to construct the
corresponding relationship of blocks in the source and reference images (the reference images and their masks are not
showcased in Figure 5). These examples exhibit that our algorithm can produce natural results even if the masks are
rough.
Figure 6 shows more examples of our gradient-preserving
color transfer algorithm (Example #5 – #10).
We implement Reinhard et al.’s, Pitie et al.’s, and our algorithms in Matlab 7.7. Table 1 shows the execution time
of the Matlab codes of the three algorithms for the ten examples showed in Figure 1, 2 and 6. We can find that the
computational speed is the disadvantage of our method. The
main consumer of CPU time in our algorithm is in the step of
solving a huge-scale linear system of equations. There exist
many efficiet techniques of solving huge-scale linear equations which were reported owning realtime performance, e.g.
Agarwala’s quadtree-based scale reduction method [Aga07],
c 2009 The Author(s)
Journal compilation c 2009 The Eurographics Association and Blackwell Publishing Ltd.

Xuezhong Xiao & Lizhuang Ma / Gradient-Preserving Color Transfer

1883

(a)

(b)

(c)

(d)

(e)

Example #2

Example #3

Example #4

Figure 2: Examples of the comparison among color transfer algorithms: (a) source images; (b) target images; (c) the results
by Pitie et al.’s algorithm; (d) the results by Reinhard et al.’s algorithm; (e) the results by our method.

c 2009 The Author(s)
Journal compilation c 2009 The Eurographics Association and Blackwell Publishing Ltd.

Xuezhong Xiao & Lizhuang Ma / Gradient-Preserving Color Transfer

1884

(a) Source image

(b) Reference image

(c) λ = 1

(d) λ = 10

Figure 4: The example showcases the variation of our results while the weighting coefficient λ is changed.

(a) Source images

(b) Color-masked source images

(c) Our results

Figure 5: Examples of our algorithm in local conditions. The masks are utilized to construct corresponding relationships
between the blocks in the source and reference images.

Bolz et al.’s generalized GPU multigrid method [BFGS03].
Therefore, we have reasons to believe that our gradientpreserving color transfer algorithm can be improved significantly in speed after using these acceleration methods.
6. Conclusion and Future Work
In this paper, we present a novel gradient-preserving color
transfer algorithm. To achieve a perceptually plausible result, it is necessary for color transfer with high fidelity to
preserve the gradients of source images and the color distribution of reference images. Then, we formalize the targets
as solving an optimization problem with two steps and solve
them successfully. Also, we propose an evaluation metric for
measuring the fidelity of global color transfer algorithms ob-

jectively. The experimental results verify our algorithm’s effectiveness and high fidelity and that it can be used to deal
with local color transfer.
Although our technique can acquire high fidelity in terms
of gradient and color, it needs more computing resources
including time and memory for it involves solving a hugescale linear system of equations. Despite it can be realtime after utilizing acceleration algorithm, e.g. the generalized GPU multigrid methods [BFGS03,GWL∗ 03] and Agarwala’s quadtree-based technique [Aga07], our algorithm is
less efficient in time and space than Reinhard et al.’s method.
Therefore, users should weigh the efficiency and fidelity to
choose Reinhard et al.’s algorithm or ours.
In the future, we plan to research on more effic 2009 The Author(s)
Journal compilation c 2009 The Eurographics Association and Blackwell Publishing Ltd.

Xuezhong Xiao & Lizhuang Ma / Gradient-Preserving Color Transfer

1885

#5

#6

#7

#8

#9

#10

(a) Source images

(b) Reference images

(c) Our results

Figure 6: Some examples of our gradient-preserving color transfer.
c 2009 The Author(s)
Journal compilation c 2009 The Eurographics Association and Blackwell Publishing Ltd.

Xuezhong Xiao & Lizhuang Ma / Gradient-Preserving Color Transfer

1886
Example
#1
#2
#3
#4
#5
#6
#7
#8
#9
#10

Execution Time (seconds)
Pitie et al. Reinhard et al. Ours
0.61
0.092
2.14
0.49
0.096
2.15
0.51
0.096
2.18
0.57
0.091
2.10
0.51
0.095
2.19
0.56
0.103
2.26
0.55
0.096
2.11
0.56
0.097
2.06
0.56
0.097
2.17
0.56
0.097
2.13

Table 1: Execution time of the Matlab codes (our implementation) of Pitie et al.’s, Reinhard et al.’s, and our algorithms.

cient methods of solving huge-scale linear equations, and
gradient-domain manipulation techniques for image and
video processing, e.g. the vectorization of images and
videos [ZCZ∗ 09, LHM09].
Acknowledgements
We thank the reviewers for their invaluable comments and
advice. This work was supported in part by the National Basic Research Program of China No. 2006CB303105, the National Science Foundation of China No. 60873136 and the
863 National High Technology Research and Development
Program of China No. 2009AA01Z334.
References
[Aga07] AGARWALA A.: Efficient gradient-domain compositing
using quadtrees. ACM Trans. Graph. 26, 3 (2007), 94. 3, 4, 6
[AR07] AGRAWAL A., R ASKAR R.: Gradient domain manipulation techniques in vision and graphics. In ICCV 2007 Course
(2007). 3

[GWL∗ 03] G OODNIGHT N., W OOLLEY C., L EWIN G., L UE BKE D., H UMPHREYS G.: A multigrid solver for boundary
value problems using programmable graphics hardware. In SIGGRAPH/Eurographics Workshop on Graphics Hardware (San
Diego, California, 2003), Doggett M., Heidrich W., Mark W.,
Schilling A., (Eds.), Eurographics Association, pp. 102–111. 6
´
S.: Measuring colourful[HS03] H ASLER D., S ´L ZSSTRUNK
ness in natural images. In IS&T/SPIE Electronic Imaging 2003:
Human Vision and Electronic Imaging VIII (2003), vol. 5007,
pp. 87–95. 3, 4

[LFUS06] L ISCHINSKI D., FARBMAN Z., U YTTENDAELE M.,
S ZELISKI R.: Interactive local adjustment of tonal values. ACM
Transactions on Graphics 25, 3 (July 2006), 646–653. 3
[LHM09] L AI Y.-K., H U S.-M., M ARTIN R. R.: Automatic and
topology-preserving gradient mesh generation for image vectorization. ACM Transactions on Graphics 28, 3 (2009). 8
[LM71] L AND E. H., M C C ANN J. J.: Lightness and retinex theory. J. Opt. Soc. Am. 61, 1 (1971), 1–11. 1
[MMS06] M ANTIUK R., M YSZKOWSKI K., S EIDEL H.-P.: A
perceptual framework for contrast processing of high dynamic
range images. ACM Transactions on Applied Perception 3, 3
(2006), 286–308. 3
[MP08] M C C ANN J., P OLLARD N. S.: Real-time gradientdomain painting. ACM Transactions on Graphics 27, 3 (2008),
93:1–93:8. 3
[PKD05] P ITIE F., KOKARAM A., DAHYOT R.: N-dimensional
probability density function transfer and its application to color
transfer. In Proceedings of the Tenth IEEE International Conference on Computer Vision (2005), vol. 2, pp. 1434–1439. 3,
4
[RAGS01] R EINHARD E., A SHIKHMIN M., G OOCH B.,
S HIRLEY P.: Color transfer between images. IEEE Computer
Graphics and Applications 21, 5 (Sept. 2001), 34–41. 1, 2, 4
[TJT05] TAI Y.-W., J IA J., TANG C.-K.: Local color transfer
via probabilistic segmentation by expectation-maximization. In
IEEE Computer Society International Conference on Computer
Vision and Pattern Recognition (2005), pp. I: 747–754. 1, 2
[TJT07] TAI Y.-W., J IA J., TANG C.-K.: Soft color segmentation
and its applications. IEEE Transactions on Pattern Analysis and
Machine Intelligence 29, 9 (2007), 1520–1537. 1, 2
[WAM02] W ELSH T., A SHIKHMIN M., M UELLER K.: Transferring color to greyscale images. ACM Transactions on Graphics
21, 3 (July 2002), 277–280. 1, 2

[BFGS03] B OLZ J., FARMER I., G RINSPUN E., S CHRÖDER P.:
Sparse matrix solvers on the GPU: conjugate gradients and multigrid. ACM Trans. Graph. 22, 3 (July 2003), 917–924. 3, 6

[Wer35] W ERNER H.: Studies on contour: I. qualitative analyses.
The American Journal of Psychology 47, 1 (1935), 40–64. 1

[CSN03] C HANG Y., S AITO S., NAKAJIMA M.: A framework for transfer colors based on the basic color categories. In
CGI’2003 (2003), IEEE Computer Society, pp. 176–183. 1, 2

[WHCO08] W EN C.-L., H SIEH C.-H., C HEN B.-Y., O UHYOUNG M.: Example-based multiple local color transfer by
strokes. Computer Graphics Forum 27, 7 (2008), 1765–1772.
1, 2

[CSN07] C HANG Y., S AITO S., NAKAJIMA M.: Example-based
color transformation of image and video using basic color categories. IEEE Transactions on Image Processing 16, 2 (2007),
329–336. 1, 2

[WM08] W INKLER S., M OHANDAS P.: The evolution of video
quality measurement: From psnr to hybrid metrics. IEEE Transactions on Broadcasting 54, 3 (2008), 660–668. 3

[CYX06] C HEN G. H., YANG C. L., X IE S. L.: Gradient-based
structural similarity for image quality assessment. In Proceedings of ICIP’2006 (2006), pp. 2929–2932. 3

[XZL09] X IANG Y., Z OU B., L I H.: Selective color transfer with
multi-source images. Pattern Recognition Letters, available online (2009). 3

[FFLS08] FARBMAN Z., FATTAL R., L ISCHINSKI D., S ZELISKI
R.: Edge-preserving decompositions for multi-scale tone and detail manipulation. ACM Trans. Graph. 27, 3 (2008), 67:1–10. 3

[ZCZ∗ 09] Z HANG S.-H., C HEN T., Z HANG Y.-F., H U S.-M.,
M ARTIN R. R.: Vectorizing cartoon animations. IEEE Transactions on Visualization and Computer Graphics 15, 4 (July/Aug.
2009), 618–629. 8

[FLW02] FATTAL R., L ISCHINSKI D., W ERMAN M.: Gradient
domain high dynamic range compression. ACM Transactions on
Graphics 21, 3 (July 2002), 249–256. 3

[Zen86] Z ENZO S. D.: A note on the gradient of a multi-image.
Computer Vision, Graphics, and Image Processing 33, 1 (1986),
116–125. 4
c 2009 The Author(s)
Journal compilation c 2009 The Eurographics Association and Blackwell Publishing Ltd.

