2009 Sixth International Conference on Computer Graphics, Imaging and Visualization

BRDF Valid Sampling Based On Gradient Magnitude Synthetic Analysis
Zhou Zeng, Lizhuang Ma, Zuoyong Zheng
The School of Electronic, Information and Electrical Engineering
the University of Shanghai Jiao Tong
ShangHai, P.R.China
Email: bluecourse@china.com, ma-lz@cs.sjtu.edu.cn, oliver.zheng@sjtu.edu.cn

points detect algorithm based on this basic principle and
assumption.
The difference reflectance property between invalid sample point and its surrounding points can be recognized
by estimating the change of gradient magnitude of each
point according to usual edge detection algorithms, such
as Canny [4], Sobel [5], Prewitt [6] and so on. But the
gradient magnitude info that extracted from single image
cannot provide enough info to implement validity checking.
So first, we classify all possible edge points as several ranks
based on their gradient magnitude info at each illumination
orientation. Second, we merge all rank info at various
illumination orientations to obtain synthetical rank info of
each possible edge points. Third, the complex object will
be plotted out many convex or flat areas in order to avoid
serious effect of shape. Finally, the validity of sample points
will be estimated by some statistical rules according to their
merged rank in each segmented area.
We found that the rank of sample points vary from high
to low responds to change of the distribution of sample
points vary from specualr to diffuse area. So after evaluate
the invalid areas, we can distribute valid sample points
reasonably and efficiently by their rank info based on this
rule.
Our experiment results confirm that the algorithm is very
sensitive to tiny stains, nicks on the surface of material.

Abstract—In general, there are some minor flaws on the
surface of homogeneous material, such as stains, nicks, will
produce unfavorable effects on isotropic BRDF measurement,
especially for highlight material. In this paper, we present a
numerical technique, which can efficient solve this problem
by gradient magnitude synthetic analyse. We measure BRDF
by fixing camera and rotating light source. We found that
nicks or stains will exhibit different properties from their
surrounding material in some special light orientations. A novel
algorithm is defeloped to detect tiny nicks or stains based on
this principle. We merge gradient magnitude info of possible
edge points by common edge detection algorithms at all light
source orientations and classify edge points as several ranks,
and then check invalidity of edge points and rational distribute
them by comprehensive analyze the rank of each point.
Keywords-BRDF Sampling; Gradient Magnitude;

I. I NTRODUCTION
To render accurate scene or object reliably and easily,
the reflectance of surfaces must be simulated accurately.
We must measure the Bidirectional Reflectance Distribution
Function (BRDF) [1] in order to completely capture the
reflectance of an opaque surface. For accurate measurement,
it’s highly demanding to material. If sample points are
located in these areas where many tiny stains or nicks
on the material’s surface, errors might occur. The most
former method of reducing errors is setting the lowest and
highest thresholds in the statistical sense after computed all
BRDFs. It’s not accurate of course. Moreover, the invalid
areas are so tiny that their reflectance property are very
similar with their surrounding areas in many light source
orientations. Therefore, they cannot be detected just from a
singly image by common detection algorithms. In order to
address the problem,first, our scheme check invalid sample
areas by gradient magnitude synthetic analyse after obtained
measurement data, and then rational distribute valid ones
outside invalid areas before computing BRDFs.
We built BRDF system inspired by [2][3]. During BRDF
measurement, we fixed camera and object and obtained various BRDF data by rotating light source. We found that the
sample points located in the nicks or stains which reflectance
properties are very different from their surrounding points
at some special light source orientations. At the same time,
to avoid producing shadows we assume that all objects are
composed of convex or flat facets. We build invalid sample
978-0-7695-3789-4/09 $25.00 © 2009 IEEE
DOI 10.1109/CGIV.2009.14

II. VALID S AMPLING BASED ON G RADIENT
M AGNITUDE S YNTHETIC A NALYZE
A. The Principle and Scheme of Estimate Invalid Sample
Points
Invalid sample points located in the nicks or stains which
reflectance properties are very different from surrounding
points at various illumination orientations. The usual edge
detection algorithms can determine these possible invalid
points by estimating the change of gradient magnitude of
each pixel. In general, edge detection algorithms focus on
the analysis of adjacent pixels instead of adjacent tiny areas.
It’s not conducive to the check of effective points. Moreover,
it’s cannot provide sufficient and stable detected edge info
just in single image. To attack problems, firstly, we merge
all detected edge points at various light source orientations
together. Secondly, we classify them into different ranks
11

Figure 2. Gradient magnitude rank images of a metal ball at different
light source rotate angles. Set
= 5 , the correlation between color and
rank with format (rank-color): 5-red, 4-green, 3-blue, 2-yellow, 1-cambridge
blue, 0-black.

can detect the sensitive change of rank in the highlight area.
⎧
0, if k = 0
⎪
⎪
⎪
⎪
⎨ T , if m f (T ) = (T · k · n)/( − 2)
m
i
Tk =
(2)
i=0
⎪
⎪
,k,
m
∈
[1,
−
2]
⎪
⎪
⎩
1, if k = − 1
⎧
/P
⎨ 0, if Pu,v ∈
k, if Tk−1≤ Gu,v ≤ Tk , Pu,v ∈ P, k ∈ [1, − 1]
Ru,v =
⎩
, if Gu,v > 1, Pu,v ∈ P
(3)
where P is a collection of possible edge points, represent
the number of rank, n is the total number of possible edge
points, Tk represent threshold of rank k, T predefine the
threshold of rank − 1, for example, if set T = 0.9, it
means that there are ten percent edge points with rank −
1, f (T ) is a function that statistic the number of points
with the same gradient magnitude T , Pu,v represent edge
point at image coordinate (u, v), Gu,v is gradient magnitude
of Pu,v , Ru,v is estimated rank of Pu,v . The rank of each
edge point varies with light source orientations and in single
image, edge points are not dense enough to provide info for
judgment (See Fig. 2). We address this problem by merging
gradient magnitude rank under all light source orientations
refer to Formula 4.

Figure 1. Flowchart of this research. The pretreatments include estimate
and merget gradient magnitude rank, and plot out distribution area. The
core process is to estimate invalid sample points by analyzing four kinds
of invalid cases. At last, the valid sample points are rational distributed
according to their ranks.

by gradient magnitude info. Thirdly, invalid sample points
will be ensured by comprehensive analyzing the distribution
of their ranks in tiny areas. Finally, distribute valid sample
points reasonably according to their rank info. Fig. 1 shows
the integrated process of our scheme. An assumption: The
objects are regard as composed of convex or flat facets,
without concave facets in order to remove shadows. This
assumption is also accord with the requirement of usual
BRDF measurement.
B. Implementation of Estimate Invalid Sample Points
1) Estimate and Merge Gradient Magnitude Rank: During measurement, we fixed camera and object and obtained
various BRDF data by rotating light source. We use Canny
algorithm [4] to detect edge points and record their gradient
magnitude. Canny algorithm implement by four steps: 1.
Smooth image by gauss filter. 2. Compute gradient magnitude and direction by Formula 1. 3. Implement non-maxima
suppression to gradient magnitude; 4. Detect and join edge
by double thresholds.

Ru,v = fmax (Ru,v (i)), i ∈ [1, m]

where fmax is a function to obtain max value, Ru,v (i)
represent rank of coordinate (u, v) in image i. To define
the rank mergence formulation, we select some points in
an invalid area and statistic their ranks at 71 different light
source orientations (See Fig. 3). Fig. 3(b) shows the merged
rank image of this invalid area in Fig. 3(a), which marked
with red and rank is 5, its surrounding areas marked with
green and rank is 4. Fig. 3(c) shows the relationship between
rank and light source orientations. In this case, the invalid
area can be detected only at sixth light source orientation.
From it we can learn that the invalid area can be detected
only at some special light source orientations. So in order to
capture the subtle change of rank in invalid area, we define
the maximal merged rank as point’s rank among all light

φ(m, n) =
f (m, n) ·

−1 −1
1
1

2

+ f (m, n) ·

1 −1
1 −1

(4)

2

(1)
where f (m, n) is image function. Our scheme aim at
detecting possible edge points instead of absolute ones.
So we ignore step 3 and 4 of standard Canny algorithm.
The possible edge points can be classified as several ranks
according to their gradient magnitude refer to Formula 2, 3.
Formula 3 determines the rank of possible edge points based
on the thresholds predefined in Formula 2. Moreover, we use
high dynamic range images in our measurement so that we

12

Figure 5. Plot out results. (a) a complex plastic object (b) a complex
sand metal object. The left images are initial merged rank image, different
colors represent ranks like Fig. 2; the middle images are covered with 8×8
pixel window; the right images are plotted results, different colors represent
plotted areas.

Figure 3. The principle to define Formula 4. (a) a small invalid area.
(b) the merged rank image, red line mark invalid area. (c) the ranks of
eleven points in invalid area at 71 light source orientations. Different color
represents different rank.

m

=

− 2 or

− 1.

fR (j) − TRV , Υi = fR (i + 1)
Υi = fR (i)/
j=0
⎧
⎨ v = i, m = i + 1, if ∀Υi ∀Υi (Υi ≥ 0 ∧ Υi > 0)
if ∀Υi ∀Υi (Υi ≥ 0 ∧ Υi = 0)
v = i, m = i,
⎩
i, j ∈ [0, ]
(5)
where fR (i) is a function that count the number of points
with rank i in whole image; TRV is a threshold to estimate
valid rank v , based on our experience, TRV = 0.02 can
meet usual conditions.
3) Plot Out Distribution Area: We assume that all objects
are composed of convex or flat facets. So the complex object
will be plotted out many convex or flat areas first, and then
evaluate them separately in order to avoid serious effect of
shape. Simple object only has one area, such as sphere,
but contrary to the complex object. Plot rules are listed as
follows:
a) Define 8 × 8 pixel window and cover the merged rank
image with it to decrease disturbance. Then estimate rank
of each window by counting the pixel number of each rank
in this window.
b) To convex or flat facets, their ranks always distribute
from high level to low level starting from their central area,
which is an important clue for segmentation. First estimate
roughly the center of each area by analyzing the pixel windows which rank equal to v or m . Then centered around
estimated center, the recursion operation is implemented in
its surrounding eight directions to detect the whole area in
accordance with the rules of Formula 6.

Figure 4. Merged gradient magnitude rank image at 71 different light
source orientations. (a) a specular ball and its merged rank. (b) a diffuse
ball and its merged rank. The relation between color and rank is the same
as Fig. 2.

source orientations in Formula 4. Fig. 4 shows the merged
rank of two classic materials with different T . Generally,
specular object has more strong reflectance, its T would be
larger than diffuse one in expressing the correct highlight
range.
2) Estimate Valid and Maximal Merged Gradient Magnitude Rank: The range of merged gradient magnitude varies
with different reflectance property of material. So it will
exist rank scarcity sometimes. We define valid merged rank
v and maximal merged rank
m refer to Formula 5.
Commonly, specular material has v = , m = ; halfsand metal material and diffuse material have v = − 1,
− 1 or ; sand or rough material have v = − 2,
m =

fre (Wc ) → fre (Wi ),

if

c

≥

i,

i ∈ [0, 7]

(6)

where fre is recursion function; Wc is current recursion
window; Wi is next recursion window; c and i are rank

13

of Wc and Wi separately. Fig. 5 shows plot out results of
two complex objects.
4) Estimate Rank of Sample Points: To estimate invalid
points, sample points must be projected from world coordinate to image coordinate by sampling densely (see Fig. 8
(a1), (b1), (c1), (d1), (e1)) Then we can estimate rank of
sample points in image coordinate refers to Formula 7. We
first statistic the rank of pixel points center around each
sample point in u¯ × v¯ window to compute initial rank, and
then extend window size to 2¯
u × 2¯
v and estimate again to
adjust initial rank. The rank which can’t be confirmed is set
to −1.
u, v¯, i)/
Υi = fR (¯

Figure 6. Adjusted area centers. White stains represent area centers, red
circles mark the roughly estimated areas and red rectangles for adjusted
ones.

fR (¯
u, v¯, j) − TRS ,
j=0

u, 2¯
v, i) − fR (¯
u, v¯, i))/
Υi = (fR (2¯
(fR (2¯
u, 2¯
v , j) − fR (¯
u, v¯, j)), i, j ∈ [0, ]
i, if ∀Υi ∀Υi (Υi ≥ 0 ∧ Υi ≥ 1)
s =
−1, if ∃Υi ∃Υi (Υi < 0 ∨ Υi < 1)

c) The invalid point is very tiny and crosses valid points,
so usually, the rank of sample point which in invalid area
cannot be ensured and marked with −1 according to Formula
7. So it’s only need to check the validity of sample points
which rank are −1 .
We treat Pc as area center, Pi as a sample point which
rank equal to −1. The estimation steps that obey the above
rules can be expressed as follows:
Firstly, to each Pi , set a narrow sector area in the direction
−−→
of Pc Pi centers on Pc (See Fig. 7 (a)). Select the points that
around Pi and close with Pc by considering their distance
reach Pc , refer to Formula 10.
⎧
⎨ if fd(Pi , Pc ) ≤ fd (Pi , Pc )
√
Pi ∈ {Pi }
if fd(Pi , Pc ) ≥ fd (Pi , Pc ) − Tn · u
¯2 + v¯2
⎩
i = −1, Pi = Pi
(10)
where Pi , i represent a point in sector area and its rank
fd (a, b), compute distance between two points, u¯, v¯ have
been defined in Formula 7, Tn is used to control range of
collection {Pi }.
Secondly, we estimate rank of ambient area of Pi i.e. rank
of {Pi }. If Pi lie on the cross boundary of tow ranks (See
Fig. 7 (a) P1 and {P1 }), the surrounding area will be hard to
evaluate its rank and must extend its range. Otherwise, the
rank can be easily evaluated (See Fig. 7 (a) P2 and {P2 })).
{Pi }’s range regulated by parameter Tn . Pi is found to be
in the cross boundary when the rank of its surrounding area
is ensured in larger evaluation range i.e. Tn > 1. In this
case, we believe that the real rank of Pi ’s surrounding area
will be lower than its evaluated one, according to first rule.
Formula 11 synthesizes all conditions to estimate rank of
Pi ’s surrounding area.

(7)

where u
¯, v¯ are average value between two neighboring
sample points in U, V direction separately; fR (a, b, i) is a
function that count the number of pixel points with rank i
in a × b size window; TRS is a threshold to estimate valid
rank s , TRV = 0.6 can meet usual conditions.
5) Estimate Accurate Area Center: In Section. II-B3, area
center have been estimated roughly, now we must adjust
it and ensure it’s accurate enough to check invalid sample
points. The adjust steps are shown as follows:
a) For each area, we compute the average position of all
sample points which rank equal to v , and define it as initial
center position, refer to Formula 8.
n

Pc (u, v,

v)

=

Pi (u, v,

v )/n

(8)

i=1

where Pi (u, v, v ) is a sample point Pi at image coordinate
(u, v) with rank v , Pc is initial center position.
b) Centered around Pc , the recursion operation is implemented in its surrounding eight directions to adjust the area
in accordance with the rules of Formula 9.
fre (Pc ) → fre (Pi ), if

γi ≥ 0, i ∈ [0, 7]

(9)

where fre is recursion function; Υi has been defined in
Formula 7. Fig. 6 shows adjusted area centers.
6) Estimate Invalid Sample Points: We design invalid
sample points estimation algorithm based on the following
rules:
a) To convex or flat facets, their ranks always distribute
from high to low starting from their central area. So if
sample point with high rank appears in lower rank area,
it should be invalid and vice versa.
b) Invalid sample point and its surrounding points have
different rank because of their different reflectance property.
It’s an important clue for determining the validity of sample
points.

Υi = fR ({Pi } , i)/
Tn =
i

14

=

j=0

fR ({Pi } , j) − TR , Tn = 1

Tn , if ∃Υi (Υi ≥ 0)
Tn + 1, if ∀Υi (Υi < 0)
i, if ∀Υi (Υi ≥ 0 ∧ Tn = 1)
i − 1, if ∀Υi (Υi ≥ 0 ∧ Tn > 1)

(11)

where i is surrounding rank of Pi and i ∈ [0, ]; fR is
a function that count number of sample points with rank i
in collection {Pi }; TR is a threshold to estimate rank of
{Pi }, based on our experience, TR = 0.6 can meet usual
conditions.
Finally, we check invalid sample points by Formula 12,
it sum up all invalid states in four cases. It first statistic
¯ × v¯ window
pixel points center around sample point Pi in u
to compute Υ, the ratio of pixel number in each rank to
total pixel number, and then judge invalid sample points by
analyze the relationship between Υ and Pi ’s surrounding
rank.
Υj = fR (¯
u, v¯, j)/
fR (¯
u, v¯, k)
k=0
⎧
CaseI : if ∃j(((j > i + 1) ∨ (j < i − 1))
⎪
⎪
⎪
⎪
∧ (Tn = 1) ∧ (Υj ≥ T1 ))
⎪
⎪
⎪
⎪
: if ∃j((j = i ) ∧ (Υj > Υ i )
CaseII
⎪
⎪
⎪
⎪
∧ (Tn = 1))
⎨
CaseIII : if ∃j(((j = i + 1) ∨ (j = i − 1))
Pi ∈ {P }
⎪
⎪
∧ (Tn = 1) ∧ (Υj ≥ T2 ))
⎪
⎪
⎪
⎪
⎪ CaseIV : if ∃j((j = i ) ∧ (Tn > 1)
⎪
⎪
⎪
∧ (Υj ≥ T3 ))
⎪
⎪
⎩
j ∈ [0, ], T1 < T2 < T3
(12)

Figure 7. Several cases to judge invalid sample points. (a) shows two
cases when estimate rank of Pi , the area of Pi is marked with red
circle, the area of Pi is marked with blue circle, white lines mark the
narrow sector areas. (b), (c) (d) (e) display four cases to judge invalid
sample points, the red arrow marks the direction from high rank to low
rank, red circles include invalid area. The mean of colors is the same as
Fig. 2

where {P } is a collection of invalid sample points, Tn
and fR have been defined in Formula 7 and 11 separately,
T1 , T2 , T3 are thresholds in each cases, based on our experience, T1 = 0.1, T2 = 0.2, T3 = 0.3 can meet usual
conditions. The following are summarized invalid cases:
Invalid Case I (See Fig. 7(b)): If exist pixel points in
u
¯ × v¯ window and there are more than two ranks difference
between these pixels and Pi ’s surrounding area and their
ratio surpass T1 , then Pi should be invalid.
Invalid Case II (See Fig. 7(c)): If the ratio of sample points
which rank differ with Pi ’s surrounding area is larger than
that of sample points which rank same as Pi ’s surrounding
area, Pi will be regard as invalid.
Invalid Case III (See Fig. 7(d)): If exist pixel points in
u
¯ × v¯ window and there are one rank difference between
these pixels and Pi ’s surrounding area and their ratio surpass
T2 , then Pi should be invalid. This case should be more
common than Case I, and the threshold of this case should
be larger than that of Case I.
Invalid Case IV (See Fig. 7(e)): It’s a supplement to
Case II. To estimate the validity of Pi when it’s on the
cross boundary between two ranks by refer to Tn and new
threshold T3 .
7) Distribute Valid Sample Points: We can classify sample points into three sorts: (a) always in sepcular areas; (b)
varies between specualr and diffuse areas as light source
orientation changes; (c) always in diffuse areas. Class (a)
means a great deal to fit specular parameters, especially
for object with specular base. Class (b) has so much more
reflectance info than Class (c). In addition, Class (a) can

be ignored for object with diffuse base. To sum up the
above arguments, we order the significance as Class(a) >
Class(b) > Class(c). The rank of sample points vary from
high to low responds to change of the distribution of sample
points vary from specualr to diffuse area. Therefore, valid
sample points can be classified according to their ranks and
allocate the number of sample points to each rank in accord
with exponent descending rule from high rank to low rank.
Formula 13 shows allocation strategy based on exponent
descending rule.
Υ =

k=0
⎧

ηi,j =

e(k·Υi ) /( + 1), Υi,j = fR (i, j)/

fR (i, k)
k=−1

⎪
⎪
⎨

e(j·Υi ) /(

⎪
⎪
⎩

Υ /(

e(k·Υi ) + Υ ) · ni , j ∈ [0, ]

k=0

k=0

e(k·Υi ) + Υ ) · ni , j = −1

(13)
where ηi,j is the allocated points number with rank j and
in area i, ni is the total points number in area i.
Fig. 8 shows the results of estimated invalid sample points
and the distribution of valid sample points. We measured five
different materials. Fig. 8 a1-a6 show a metal ball with a few
nicks and stains. The images form left to right are sample
range (a1), estimated invalid sample areas and distribution
of valid sample points in rank image (a2), valid sample
points distribution in real object (a3), the local details in
some appointed areas (a4), (a5), (a6). From detail images
we can know that sample points have been away from the
nicks and stains. (a5), (a6) show the distribution of valid

15

Figure 8. The results of estimate invalid sample points and distribute valid sample points. The mean of colors is the same as Figure 2. a1, b1, c1, d1,
e1 display the sample areas which projected from world coordinate to image coordinate and marked by dense white points; a2, b2, c2, d2, e2 display
estimated rank image, which covered with distributed valid sample points (red color), the invalid areas are marked by white color. a3, b3, c3, d3, e3 show
valid sample points (green color) distribution in real image; a4, a5, a6, b4, b5, b6, c4, c5, c6 show details in appointed areas and the areas are marked
with red rectangle in a2, a3, b2, b3, c2, c3.

and will allocate the fewer sample points in these areas based
on exponent descending distribution rule.
In order to test algorithm’s efficiency, we also provide
another metal ball with many nicks and stains (c1-c6). Most
nicks and stains are also found out and sample points are
distributed away from invalid areas (c4), (c5), (c6). We
especially test a wave shape object (d1-d3), in order to show
the distribution strategy. From (d2), (d3) we can know that
in specular areas (marked with green color) distribute more
sample points than in diffuse areas (marked with yellow
color). Finally, we test a diffuse object (e1-e3), the valid
sample pints evenly distributed in the whole sample area.

sample points in the same area with different light source
orientations, one is light source at initial position, another
is light source rotated 120 degree. Some obvious nicks and
stains in (a5) become invisible or unnoticeable in (a6) and
some invisible nicks and stains in (a5) become noticeable
in (a6). Our scheme found out all nicks and stains under all
light source orientations by merging ranks.
Fig. 8 b1-b6 show a complex object. It’s appointed area 1
include some convex characters which reflectance properties
are different from surrounding areas (b4), so they are viewed
as invalid. It’s appointed area 2 and 3 include obvious
concave faces, which can produce shadows to effect the
accuracy of BRDF. According to our algorithm, the bottom
of concave faces is evaluated as invalid area (marked with
white color) and no sample points will be allocated in
this area. Moreover, the areas include concave faces are
estimated with the lowest rank (marked with yellow color)

III. C ONCLUSION
In this paper we have presented an algorithm for efficient
detect invalid sample area such as tiny stains, nicks on the
surface of material by gradient magnitude synthetic analyse.

16

At the same time, our scheme has some limitations: (1)
It only acts on homogeneous material, because there are
heavy interference on the boundary of different materials
to inhomogeneous object. (2) It only acts on isotropic
BRDF measurement. For future work we like to extend this
algorithm and use it for inhomogeneous material.
ACKNOWLEDGMENT
Research supported in part by Omron Corp. (Project V9:
Study of measurement system of reflectance property).
R EFERENCES
[1] NICODEMUS, F. E., RICHMOND, J. C., HSIA, J. J., GINSBERG, I. W., AND LIMPERIS, T. 1977. Geometric Considerations and Nomenclature for Reflectance. National Bureau of
Standards (US).
[2] S. R. Marschner. Inverse Rendering for Computer Graphics.
PhD thesis, Cornell University, 1998.
[3] W. Matusik, H. Pfister, M. Brand, and L. McMillan. A
Datadriven Reflectance Model. ACM Trans. Graph., 22(3):759
- 769, 2003.
[4] J. Canny A Computational Approach to Edge Detection, IEEE
Transactions on Pattern Analysis and Machine Intelligence,
Vol. 8, No. 6, Nov. 1986.
[5] Health ASarkar SSanocki Tet a1Comparsion of Edge Detectors: A Methodology and Initial Study[J]Computer Xrtsion and
Image Understanding199869(1)38-54.
[6] Prewitt J M S, Menclelsohn M L. The Analysis of
Cell Images[J]. Annals of the N.Y.Academy of Sciences.
1966,128:1035-1053.

17

