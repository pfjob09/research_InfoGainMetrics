Volume 27 (2008), Number 2

EUROGRAPHICS 2008 / G. Drettakis and R. Scopigno
(Guest Editors)

The Beam Radiance Estimate for Volumetric Photon Mapping
Wojciech Jarosz

Matthias Zwicker

Henrik Wann Jensen

University of California, San Diego

Abstract
We present a new method for efficiently simulating the scattering of light within participating media. Using a
theoretical reformulation of volumetric photon mapping, we develop a novel photon gathering technique for
participating media. Traditional volumetric photon mapping samples the in-scattered radiance at numerous points
along the length of a single ray by performing costly range queries within the photon map. Our technique replaces
these multiple point-queries with a single beam-query, which explicitly gathers all photons along the length of an
entire ray. These photons are used to estimate the accumulated in-scattered radiance arriving from a particular
direction and need to be gathered only once per ray. Our method handles both fixed and adaptive kernels, is faster
than regular volumetric photon mapping, and produces images with less noise.
Keywords: participating media, light transport, rendering, photon map, ray marching, variable kernel method.
Categories and Subject Descriptors (according to ACM CCS): I.3.7 [Computer Graphics]: raytracing; color, shading,
shadowing, and texture; I.6.8 [Simulation and Modeling]: Monte Carlo;

1. Introduction
The appearance of many natural phenomena, such as human
skin, clouds, fire, water, or the atmosphere, are strongly influenced by the interaction of light with volumetric media.
Therefore, efficiently rendering scenes with participating media has been an area of interest within computer graphics.
This problem is challenging, however, because accurately
simulating light transport in participating media is computationally very expensive. Cerezo et al. [CPP∗ 05] provide a
recent and comprehensive overview of the wealth of research
that has been devoted to address this problem.
Light transport in arbitrary participating media is modeled
by the radiative transfer equation [Cha60]. The pioneering
contributions by Kajiya and von Herzen [KH84] and Rushmeier and Torrance [RT87] are at the beginning of a long
list of work on rendering participating media in the computer
graphics community. Some of the most popular techniques
to date are based on stochastic path-tracing and Monte Carlo
integration [PM93, LW96, PKK00]. These approaches are
attractive because of their sound underlying theoretical framework and their generality. They are unbiased and guaranteed
to converge to the exact solution. In addition, it is straightforward to include heterogeneous media, anisotropic phase
functions, and scattering from surfaces. The downside of
these approaches is that they suffer from noise that can only
be overcome with a huge computational effort.
c 2008 The Author(s)
Journal compilation c 2008 The Eurographics Association and Blackwell Publishing Ltd.
Published by Blackwell Publishing, 9600 Garsington Road, Oxford OX4 2DQ, UK and
350 Main Street, Malden, MA 02148, USA.

One strategy to solve this issue is to make simplifying assumptions about the participating media. For example, homogeneous media with a high scattering albedo can be modeled
accurately using a diffusion approximation [Sta95, JMLH01],
which leads to very efficient rendering algorithms. Premoze
et al. [PARN04], under the assumption that the medium is
tenuous and strongly forward scattering, use a path integral
formulation to derive efficient rendering algorithms. Sun et
al. [SRNN05] render single scattering in real time, but without shadowing effects.
In contrast, photon mapping [JC98] improves the efficiency
of path-tracing without making additional assumptions about
the properties of the medium being rendered. Similar to
Monte Carlo methods, photon mapping handles isotropic,
anisotropic, homogeneous, and heterogeneous media of arbitrary albedo. A disadvantage of photon mapping is that it
introduces bias to the solution of the radiative transfer equation. In practice, however, this bias is preferable to the noisy
solutions of pure Monte Carlo methods.
Intuitively, photon mapping works by splitting the energy
emitted by each light source into discrete packets, so called
photons. In a first pass, the propagation of light is simulated
by scattering photons in the scene. At each scattering event
(at surfaces or within the medium) the incident energy carried
by a photon is stored in a photon map. In a second pass, the
photon map is used to evaluate the radiance at discrete points

558

W. Jarosz & M. Zwicker & H. W. Jensen / The Beam Radiance Estimate

Symbol

Units

Description

σs (x)
σa (x)
σt (x)
p(x, ω, ω )
τ(x ↔ x )
Tr (x ↔ x )
Ω4π
L(x → x )
L(x, ω)
We (x, ω)
We (x → x )

m−1

Scattering coefficient at x
Absorption coefficient at x
Extinction coefficient at x
Normalized phase Rfunction
Optical thickness: xx σt (x) dx
Transmittance: e−τ(x↔x )
Sphere of directions
Outgoing radiance at x towards x
Incident radiance at x from ω
Importance at x towards ω
Importance at x towards x

m−1
m−1
sr−1
unitless
unitless
sr
W m−2 sr−1
W m−2 sr−1
m−3 sr−1
m−3 sr−1

2. Photon Mapping in Participating Media
Light transport within participating media is described by the
radiative transfer equation (RTE) [Cha60], which defines the
radiance that reaches a point x from direction ω as a sum
of the exitant radiance from the nearest surface from this
direction, and the accumulated in-scattered radiance from the
medium between the surface and x (see Figure 1). This can
be expressed as:
L(x, ω) = Tr (x ↔ xs )L(xs , ω)+
Z s

Tr (x ↔ xt )σs (xt )Li (xt , ω) dt,

0

• We derive a reformulation of volumetric photon mapping
as a solution to the measurement equation. This theory
allows for arbitrary measurements of radiance to be computed within participating media, where a measurement
is simply an integral of the radiance multiplied with a
weighting function.
• Using this new theory, we present an improved radiance
estimate for volumetric photon mapping based on “beam
gathering.” This technique eliminates the need for stepping
through the medium to find photons. Instead, it gathers all
photons along a ray. We show how to efficiently implement
this new gathering technique for both fixed and adaptive
smoothing kernels and demonstrate that our method produces images with less noise than conventional photon
mapping.

p(xt , ω, ωt )L(xt , ωt ) dωt ,

(2)

Ω4π

where p is the normalized phase function.
Volumetric photon mapping [JC98] solves the RTE using
a combination of photon tracing, ray-marching, and density
estimation. In a preprocess, packets of energy are shot from
light sources, scattered at surfaces and within the medium,
and their interactions are stored in a global data structure. During rendering, ray marching is used to numerically integrate
Equation 1 for radiance seen directly by the observer,
L(x, ω) ≈ Tr (x ↔ xs )L(xs , ω)+
S−1

∑ Tr (x ↔ xt )σs (xt )Li (xt , ω)∆t

,

(3)

t=0

where ∆s is the length of each segment along the ray and
x0 , . . . , xs are the sample points for each segment (x0 is the
point where the ray enters the medium and xs is a point on a
surface past the medium).
The most expensive part to compute in Equation 3 is the
in-scattered radiance Li , because it involves accounting for
all light arriving at each point xt along the ray from any other

object

medium













































Tr (x ↔ xs )












































The rest of this paper is organized as follows. In Section 2,
we review the theory of radiance transport within participating media and the volumetric photon mapping method.
In Section 3, we reformulate volumetric photon mapping
in terms of the measurement equation and show how the
photon map can be used to estimate any measurement of
radiance within the scene. In Section 4, we present our new
beam radiance estimate using this theory and describe the
data structures needed to evaluate it efficiently. Finally, we
show comparisons of our approach to conventional photon
mapping in Section 5 and discuss avenues of future work in
Section 6.

Z

Li (xt , ω) =

x

Li (xt , ω)

xt

L(xs , ω)
xs



















in the scene by locally computing the photon density. To compute the radiance carried along each ray towards the eye, the
radiance is estimated within the medium at several sample
points along the ray [JC98]. At each point the attenuation
through the medium to the eye is computed, and the attenuated radiance is added to the ray. The main disadvantage of
this procedure, however, is that it is difficult to find a good distribution of sample points along the ray. On one hand, if not
enough sample points are used, the result is likely to be noisy.
On the other hand, increasing the number of sample points is
very costly and can slow down rendering significantly.
In this paper, we propose a novel approach for computing
the contribution of in-scattered radiance. We gather photons
along viewing rays and analytically compute their contributions, without point sampling. We present the following
contributions:

where Tr is the transmittance, s is the distance through the
medium to the nearest surface at xs = x − sω, and xt = x −tω
with t ∈ (0, s). We define the remaining quantities in Table 1.
The surface radiance, L(xs , ω), at the boundary of the
medium is governed by the rendering equation [Kaj86]. The
in-scattered radiance, Li (xt , ω), depends on the radiance arriving at xt from all directions ωt over the sphere of directions
Ω4π and is defined as:




















Table 1: Definitions of quantities used throughout the paper.

(1)

Tr (x ↔ xt ) σs (xt )

Figure 1: The radiance reaching the eye L(x, ω) is the sum of the
radiance from the surface L(xs , ω) and the accumulated in-scattered
radiance Li (xt , ω) along a ray.

c 2008 The Author(s)
Journal compilation c 2008 The Eurographics Association and Blackwell Publishing Ltd.

559

W. Jarosz & M. Zwicker & H. W. Jensen / The Beam Radiance Estimate
Conventional Gathering

Gathered

as Equation 5, we use a more flexible derivation of particle
tracing methods presented by Veach [Vea98]. We extend this
derivation to handle participating media (Section 3.1) and
show how to represent particle tracing algorithms like volumetric photon mapping in terms of the measurement equation
(Sections 3.2 and 3.3). Finally, we show how to use the same
photon maps to estimate more general quantities of radiance
(Section 3.4).

Beam Gathering

Double-counted

Missed

Other photons

Figure 2: Conventional gathering (left) searches for photons in a
sphere around numerous samples along the ray. Our method (right)
assigns a radius to each photon and performs a single range search to
find all photons along the length of the entire ray.

point in the scene. Instead of computing these values independently for each location, photon mapping gains efficiency by
reusing the computation performed during the photon tracing
stage. The in-scattered radiance is approximated using density estimation by gathering photons within a small spherical
neighborhood of radius r around each sample location xt ,
n

Li (xt , ω) ≈

∑

i=1

p(xt , ω, ωi )∆Φi
,
4 3
3 πr

(4)

3. Reformulation of Volumetric Photon Mapping
Our technique solves these shortcomings by querying once
for photons along the length of an entire ray, instead of multiple times near points along the ray (see Figure 2). More
formally, whereas regular photon mapping estimates Li at
discrete points using Equation 4, our main contribution is to
directly estimate
0

Tr (x ↔ xt )σs (xt )Li (xt , ω) dt

∞

Lo (x1 → x0 ) =

where ∆Φi is the power of photon i, and ωi is its incident
direction [JC98].
Though photon mapping is much more efficient than bruteforce techniques like path tracing, the density estimation
requires searching for photons within a global data structure,
which is quite expensive. This formulation is suboptimal,
firstly because it may gather the same photons more than
once if the spherical neighborhoods overlap and, secondly,
because it can lead to noise if the step size is too large and
photons are omitted (see Figure 2).

Z s

3.1. Volumetric Path Integral Formulation
We use the path integral formulation of the RTE, which arises
by recursively expanding the right hand side of Equation 1.
Instead of expressing the radiance equilibrium recursively,
the resulting path integral formulation is a sum over lightcarrying paths of different lengths. For conciseness we restrict
the following derivation to include only scattering within the
volume. A full derivation incorporating scattering at surfaces
is available in a technical report [JZJ08].
A path of length k, x¯ k , with k + 1 vertices is defined as
x¯ k = x0 , x1 , . . . , xk , where light starts on a light source at xk
and scatters k −1 times within the medium before reaching x0 .
The outgoing radiance Lo at x1 towards x0 can be expressed
as a sum over all possible light paths, of any length, arriving
at x1 ,

(5)

along rays.
Though the explanation of photon mapping from the previous section is appealing at an intuitive level, it does not
rigorously present the algorithm as a numerical solution to
the RTE. Furthermore, this explanation is heavily tied to the
geometric interpretation of gathering photons within a disc
(on surfaces) or within a sphere (in participating media). In
order to avoid these limitations and use the photon map to
estimate general radiometric quantities in the volume, such
c 2008 The Author(s)
Journal compilation c 2008 The Eurographics Association and Blackwell Publishing Ltd.

¯ xk ).
∑ L(¯

(6)

k=1

¯ xk ) measures the amount of radiance transported to x1 from
L(¯
all paths of length k,
¯ xk ) =
L(¯

Z

···

A(xk )

Z
V(x2 )

Le (xk → xk−1 ) cos(θk )

(7)

k−1

∏ p(x j )G(x j+1 → x j )

dV(x2 ) · · · dA(xk ),

j=1

where V and A are the domains of the volume and surfaces
respectively (all integrals except at xk are over volume), θk is
the angle between the surface normal at xk and vertex xk−1 ,
and we use the shorthand p(x j ) = p(x j+1 → x j → x j−1 ) for
the phase function. The geometry term, G, is defined as
G(x → y) =

V (x ↔ y)σs (x)Tr (x ↔ y)
x−y

2

.

(8)

The radiance transported along an example path is shown in
Figure 3.
3.2. The Measurement Equation
Many global illumination algorithms can be described in
terms of the measurement equation. The measurement equation describes an abstract measurement of incident radiance
taken over some set of rays in a scene
Z Z

I = We , L =

V Ω4π

We (x, ω)L(x, ω) dω dV(x).

(9)

The importance function We represents an abstract measuring
sensor and is defined over the whole ray space V × Ω4π
(though typically We is non-zero for only a small subset of
this domain).

560

W. Jarosz & M. Zwicker & H. W. Jensen / The Beam Radiance Estimate

p(x1 )

Gˆ(
x

2

sensor

→

x1 )

x2

x 2)















→x



















ˆ (x 1
G

x3














































0)
















x0

x1

p(x2 )

light source

medium

→
ˆ (x 3
G

Figure 3: An example path, x¯ 3 . The radiance transported along the
¯ x3 ), is the emitted radiance at the light multiplied by a series
path, L(¯
of scattering events (blue) and geometry terms (green).
Path tracing, for instance, measures the contribution of radiance arriving over the area of a pixel. Radiosity algorithms
integrate the contribution of radiance over basis functions defined on the scene geometry. Both of these approaches can be
described using Equation 9 with an appropriate importance
function.
In his dissertation, Veach [Vea98] showed how particle tracing methods for surface illumination can also be expressed as
a solution to the measurement equation by using the path integral form of the rendering equation. We extend on this idea
and use the volumetric path integral formulation to describe
volumetric photon tracing in the same way.
3.3. Volumetric Photon Tracing
Photon tracing methods can be thought of as a way of generating samples from the scene’s equilibrium radiance distribution and then using this single collection of samples to
render the entire image. The photon tracing stage generates
N weighted sample rays, or photons, (αi , xi , ωi ), where each
(xi , ωi ) is a ray and αi is a corresponding weight. Our goal
is to use these samples to take unbiased estimates of the
radiance as a weighted sum,
E

1
N

N

∑ We (xi , ωi )αi

= We , L ,

(10)

i=1

for an arbitrary importance function We . We must therefore
determine the proper distribution of samples for Equation 10
to hold. By expanding the measurement equation (9) in terms
of the outgoing radiance using the path integral formulation
(6 and 7), it can be shown that distributing the samples using
a random-walk satisfies the necessary requirements if
αi =

Le (xi,ki → xi,ki−1 )
pdf (xi,ki , xi,ki −1 )
ki −1

∏

j=1

(11)

1 p(xi, j )G(xi, j+1 → xi, j )
G(xi,1 → xi,0 ),
qi, j
pdf (xi, j−1 )

where qi, j is the probability of terminating the walk at the jth
vertex. A detailed derivation is provided in the supplemental
technical report [JZJ08].
Connection to Conventional Photon Tracing. Though derived in a different fashion, Equation 11 is exactly how con-

ventional photon mapping distributes photons within the
scene. For instance, for a diffuse area light, photons are emitted using a cosine distribution with the power of the light
source. In Equation 11 photons are emitted with the radiance
of the light source divided by the pdf of choosing a position
and direction on the light. These quantities are equivalent.
Hence the particles generated above represent differential
flux. The correspondence between the photon powers [JC98]
and the sample weights is ∆Φi = αNi .
3.4. Radiance Estimation Using the Measurement Eqn.
The main advantage of the reformulation in Section 3.3 is that
it naturally accommodates computation of any measurement
of radiance within the scene simply by using an appropriately
defined importance function We . In this section, we first show
how the conventional estimate for in-scattered radiance can
be expressed as a measurement. We then go one step further
and show how to derive a beam radiance estimate which
approximates Equation 5 along rays directly.
Conventional Radiance Estimate. The conventional radiance estimate approximates the value of the in-scattered radiance Li at fixed points within the scene. To express this
using the theory from Section 3, we need to transform Equation 2 into the measurement equation. Since the measurement
equation is an integral over all of ray space (V × Ω4π ), we
artificially expand Li to also integrate over the volume
Z

Li (xt , ω) =

p(xt , ω, ωt)L(xt , ωt) dωt

(12)

Ω4π

Z Z

=
V Ω4π

δ( x − xt )p(x , ω, ωt)
L(x , ωt) dωt dV(x ).

In order to keep the expressions equivalent when we add
the integration over volume, we also introduce a Dirac delta
function δ.
The bottom row of the above equation is now the measurement equation where We = δ( x − xt )p(x , ω, ωt ). Hence
we can compute an unbiased estimate using the photon map
by evaluating Equation 10 with this importance function.
However, in order to obtain a useful estimate of radiance at
all points in the scene a normalized kernel function is used in
place of the delta function. This is where bias is introduced in
the photon mapping method. Another interpretation is that by
replacing the delta function with a kernel, photon mapping
computes an unbiased estimate of blurred radiance. Jensen
and Christensen [JC98] use a constant three-dimensional kernel with a radius based on the nth nearest neighbor. This
results in the following radiance estimate by applying Equation 10
Li (xt , ω) ≈

Z Z
V Ω4π

Kn ( x − xt )p(x , ω, ωt)

(13)

L(x , ωt) dωt dV(x ),
≈

1
N

N

∑ Kn (

xi − xt )p(xi , ω, ωi )αi

(14)

i=1

c 2008 The Author(s)
Journal compilation c 2008 The Eurographics Association and Blackwell Publishing Ltd.

W. Jarosz & M. Zwicker & H. W. Jensen / The Beam Radiance Estimate

The blurring in the conventional radiance estimate is spherical so the kernel needs to be normalized for 3D. However,
with the beam radiance estimate, we blur in two dimensions
(perpendicular to the ray) since the radiance we are computing already includes the integration along the ray itself.
Hence, the kernel in the beam estimate is normalized for 2D.

ω

x
t

θ
x

r

Figure 4: In the beam radiance estimate, x is parameterized in
cylindrical coordinates, (t, θ, r), about the ray (x, ω). An unbiased
estimate would only consider points directly on the ray, while a
biased version uses a kernel (shown in grey) to blur the radiance
within a beam.

where the kernel Kn is defined as
Kn (r) =

3
4πdn3

if r ∈ [0, dn ]

0

otherwise

,

(15)

and dn is the distance to the nth photon. Note that this is
equivalent to the conventional volumetric radiance estimate
in Equation 4.
Beam Radiance Estimate. A similar procedure can be used
to derive an estimate for the accumulated in-scattered radiance along an entire ray. To accomplish this, we first expand
out Li in Equation 5 and then artificially inflate the resulting
expression to integrate over the whole volume,
Z sZ
0

Tr (x ↔ xt)σs (xt)p(xt , ω, ωt)L(xt , ωt) dωt dt = (16)

Ω4π

Z Z 2πZ Z
R 0

δ(r)(H(t) − H(t − s))Tr (x ↔ x )σs (x )

R Ω4π

p(x , ω, ωt)L(x , ωt) dωt dr dθ dt.

(17)

R is the set of real numbers and x is expressed in cylindrical
coordinates, (t, θ, r), about (x, ω), where r is the radius to the
ray (see Figure 4). We have added a Dirac delta function δ
as before, and the Heaviside step functions (H(x) = 1 when
x > 0 and 0 otherwise) constrain the computation to t ∈
(0, s). Equation 17 is now equivalent to the measurement
equation where the integral over volume has been converted
into cylindrical coordinates and where We = δ(r)(H(t) −
H(t − s))Tr (x ↔ x )σs (x )p(x , ω, ωt).
Since the probability of photons landing exactly on the ray
(x, ω) is zero, we introduce bias by blurring the radiance and
replacing the delta and step functions with a smooth kernel,
K. This integral can then be estimated with the measurement
equation using the photons as:
Z Z 2πZ Z
R 0

K(t, θ, r)Tr (x ↔ x )σs (x )p(x , ω, ωt)

R Ω4π

L(x , ωt) dωt dr dθ dt =
1
N

561

(18)

N

∑ K(ti , θi , ri )Tr (x ↔ xi )σs (xi )p(xi , ω, ωi )αi ,

(19)

i=1

where (ti , θi , ri ) = xi are the cylindrical coordinates of photon
i about the ray.
c 2008 The Author(s)
Journal compilation c 2008 The Eurographics Association and Blackwell Publishing Ltd.

3.5. Kernel Radiance Estimation
For both the conventional and beam radiance estimates the
characteristics of the bias and blur are determined by the
smoothing function chosen. Several options exist for applying
a smoothing kernel to the photon map data.
The kernel method uses a fixed-radius smoothing kernel
and results in a uniform blur of radiance within the scene. In
practice, using a fixed-width circular kernel implies that in
order to evaluate the beam radiance estimate (Equation 18)
using the photon map (Equation 10) we only need to consider photons which are located within a fixed-radius cylinder
about the ray (x, ω). Alternatively, the equivalent dual interpretation considers each photon as the center of an oriented
disc facing the ray and all photon-discs that intersect the ray
need to be found.
If the density of photons varies significantly it can be difficult to choose a single radius that works well for all regions
of the scene. This can be solved by allowing the size and
shape of the blurring kernel to vary spatially. In conventional
photon mapping, the nearest neighbor method (k-NN) is
used to adapt the kernel width to the local density. Generalizing point-based k-NN to a visually comparable range search
along rays is challenging. However, spatial variation can easily be applied to the dual photon-discs interpretation using
the variable kernel method (VK) [BMP77]. A smoothing
kernel is “attached” to each photon and the radius of the kernel is allowed to vary from one photon to another, based on
the local density. In contrast to k-NN estimation, where the
kernel widths vary based on the distance from the evaluation location to the data points, in the VK method the kernel
widths only depend on the data points themselves. In order
to facilitate this, the method relies on a pilot estimate of the
local density at each data point in order to assign the kernel
widths. This is the approach we take.
4. Algorithm
In order to use the dual interpretation to evaluate the beam
radiance estimate (Equation 18), we need an efficient way
of locating all photon-discs that intersect an arbitrary ray.
Additionally, to use variable width kernels we need to efficiently compute a radius for each photon in the photon map.
At a high level, our volumetric photon mapping technique
performs the following five steps:
1.
2.
3.
4.
5.

Shoot photons from light sources.
Construct a balanced kd-tree for the photons.
Assign a radius for each photon.
Construct a bounding-box hierarchy over the photon-discs.
Use the photon BBH to render the image.

562

W. Jarosz & M. Zwicker & H. W. Jensen / The Beam Radiance Estimate

a

b

c

a

g

d

b

c

f
e

Construct balanced kd-tree

a

g
b

c

f
e

d
Compute radius per photon

g

f

d

e

Construct BBH over photon-discs

Figure 5: After photons have been distributed in the scene, our algorithm constructs a balanced kd-tree (left). We assign a valid radius to each
photon by querying in the kd-tree (middle). Finally, we rapidly construct a bounding-box hierarchy over the photon-discs (right) by reusing the
same hierarchical structure (shown in red) as the kd-tree.

Algorithm 1 C ONSTRUCT BBH(p)
Require: p is a node in a balanced photon map.
Ensure: The subtree at p contains a valid BBH.
1: B ⇐ B OUNDING B OX(p.position, p.radius)
2: if p.leftChild then
3:
B ⇐ B ∪ C ONSTRUCT BBH(p.leftChild)
4: end if
5: if p.rightChild then
6:
B ⇐ B ∪ C ONSTRUCT BBH(p.rightChild)
7: end if
8: p.bbox ⇐ B
9: return B

Steps 1 and 2 are identical to conventional photon mapping
while 3–5 are unique to our approach and are explained in
more detail below.
Photon Radius Computation. We augment the traditional
photon map by associating a radius with each photon. For
fixed width kernels the radius is a constant for all photons
and does not need to be explicitly stored. For variable width
kernels using the VK method, we perform a density estimation at each photon to assign a radius. At each photon we
compute the local density by estimating the distance to the nth
nearest photon and use this as the photon-disc’s radius. This
pilot estimate is performed using the photon map kd-tree. The
value n plays the same role as in the conventional radiance
estimate, it controls the amount of blur.
As an optimization, we only search for the nearest m n
photons and estimate the necessary radius for n photons. By
assuming locally uniform photon density, if di,m is the distance to the mth photon from photon i, we estimate the radius
as ri = di,m 3 mn . The m parameter controls the sensitivity of
the computed radius to the local variation in density. Very
small values of m, m < 5, can produce noisy radii, which
change drastically between neighboring photons, while large
values are more √
expensive to compute. In practice, we have
found that m = n works well as a default value and this
value was used for all our scenes, significantly accelerating
the preprocessing step.
Bounding Box Hierarchy Construction. In order to efficiently locate all photons-discs which intersect a ray, we

construct a bounding box hierarchy. Heuristics for constructing efficient BBHs have been extensively studied within the
context of ray tracing [WMG∗ 07]. However, the performance
characteristics of our ray intersections are different than for
regular ray tracing since we are interested in all intersections,
not just the first intersection along a ray. Furthermore, the best
heuristics tend to induce long construction times. We employ
a rapid construction scheme by exploiting the information in
the photon map kd-tree and re-using that hierarchy for our
BBH.
For each photon in the photon map, we compute the bounding box of all descendent photon-discs. The bounding box of
each node encloses the node’s photon radius and the bounding boxes of its two child nodes. The computation starts at
the leaves and propagates upwards through the tree. This
procedure results in a balanced median-split-style BBH, but
unlike traditional BBHs our hierarchy contains photons at
interior nodes, not just at the leaves. Figure 5 illustrates the
relationship between the kd-tree and the BBH. The BBH can
be constructed by passing the root of the photon map kd-tree
to Algorithm 1.
Given a balanced kd-tree, this linear-time construction
procedure is extremely fast and produces BBHs which can
be efficiently traversed for nearby photons during rendering.
After the BBH is constructed the photon map kd-tree is no
longer used and can be freed from memory. Using a BBH
and a per-photon radius, an additional 7 floating-point values
need to be stored, increasing the size of each photon from 20
bytes to 46 bytes.
The Beam Radiance Estimate. During rendering we estimate the accumulated in-scattered radiance (Equation 5)
along viewing rays by locating all photons whose bounding
spheres intersect the ray. These photons are found using a
standard ray-BBH intersection traversal. The contribution
from each photon (αi , xi , ωi ) is accumulated using Equation 18; however, with the variable kernel method, a kernel
Ki is defined per photon. This leads to the following radiance
estimate
1
N

N

∑ Ki (x, ω, s, xi , ri )Tr (x ↔ xi )σs (xi )p(xi , ω, ωi )αi ,

(20)

i=1

c 2008 The Author(s)
Journal compilation c 2008 The Eurographics Association and Blackwell Publishing Ltd.

563

W. Jarosz & M. Zwicker & H. W. Jensen / The Beam Radiance Estimate
Photon Tracing
Scene
Cornell
Stage
Cars
Lighthouse

Fixed Radius Comparison

Adaptive Radius Comparison

N

Shoot (s)

Balance (s)

Radius (s)

r

∆t

C (m)

O (m)

r+

n

∆t

C (m)

O (m)

0.4M
1M
2M
1M

1.50
3.25
19.0
2.83

0.30
0.76
1.50
0.78

2.0
5.0
2.0
6.0

0.4
0.3
0.4
0.4

0.40
0.20
1.25
0.25

3:19
4:21
1:30
1:07

3:00
4:15
1:30
0:59

0.6
0.5
0.5
0.5

1.5K
0.5K
1K
0.4K

0.80
0.70
1.25
1.00

4:03
6:38
2:02
1:12

3:35
6:22
1:53
1:05

Table 2: Rendering parameters and timings (in seconds (s) and minutes (m)) for all example scenes. Statistics relating to the photon tracing
preprocess are shown in the first table. The middle and right tables compare our method (O) to conventional photon mapping (C) using a fixed
width kernel and adaptive width kernel. The r column represents the fixed-width kernel radius, while r+ is the maximum search radius and the
number of nearest neighbors is n.

where xi = x + ti ω is the projection of the photon location
xi onto the ray’s direction ω, and ti = (xi − x) · ω. We define
the kernel as
Ki (x, ω, s, xi , ri ) =

ri−2 K2
0

di
ri

if di ∈ [0, ri ]

,

(21)

otherwise

where ri is the pre-computed radius for photon i. We use Silverman’s two-dimensional biweight kernel [Sil86] along the
ray, K2 (x) = 3π−1 (1 − x2 )2 , where di is the shortest distance
from photon i to the ray. We chose this kernel because it is
smooth, efficient to evaluate, and has local support. Equation 20 is the beam radiance estimate, and it replaces the ray
marching computation from conventional photon mapping
(second row of Equation 3).
Heterogeneous Media. For homogeneous media, the transmission terms, Tr (x ↔ xi ), can be computed explicitly for
each photon during gathering. Beam gathering in heterogeneous media can also be handled efficiently by first marching
along the ray and saving the transmission values in a 1D
lookup table. Then, during gathering, each photon’s transmission is computed by interpolating within the lookup table.
This preprocess needs to be performed independently for
each ray, just prior to gathering, so the lookup table can be
reused. Furthermore, if single scattering is simulated separately by directly sampling light sources the lookup table can
be populated during this marching step.
5. Results
We compared our beam gathering technique against conventional volumetric photon mapping using ray marching. In
order to isolate just the performance of the photon gathering
methods, we use the photon map for both single and multiple
scattering. We compared results on four test scenes: Cars,
Lighthouse, Stage, and a Cornell box. For each scene we
compare using a fixed gathering radius for both types of estimates, and we also compare the conventional estimate using
k-NN to the beam estimate using the VK method. The images
were all rendered with a maximum dimension of 1024 pixels
with up to 4 samples per pixels on an Intel Core 2 Duo 2.4
GHz machine using one core.
In our experimental setup, we first choose suitable gathering parameters (search radius and number of nearest neighbors n) and render the scenes using our method. We then use
the same parameters using conventional photon mapping but
c 2008 The Author(s)
Journal compilation c 2008 The Eurographics Association and Blackwell Publishing Ltd.

Scene
Cornell
Stage
Cars
Lighthouse

σs

σa

g

0.225
0.225
0.06
0.24

0.225
0.225
0.015
0.010

0.00
0.75
0.00
0.75

Table 3: Scattering properties of the participating media used in
each of the example scenes.

tune the minimum step-size ∆t to obtain approximately equal
render times. Note that ∆t is the minimum step-size and that
exponential stepping is used to sample the ray according to
transmission. Finally, we render a high quality result with
conventional photon mapping using a very small step size as
a “reference.”
We show visual comparisons of the methods in Figures 6–7.
All images of each scene are rendered using the same photon
map. The only differences in quality and performance are
due to the gathering method used. We report the render times
and gathering parameters, as well as timings for constructing
the photon maps in Table 2. We used the Henyey-Greenstein
phase function for all scenes with the medium parameters
specified in Table 3.
In all cases, our method produces significantly higher quality images than conventional photon mapping. This is because
querying once for all photons along a ray is more efficient
than repeatedly querying for photons near numerous samples
along the ray. Not surprisingly, we see that the reduced blurring of the adaptive kernel gathering methods is essential for
scenes like the Stage and Lighthouse, where concentrated
beams of light are visible. However, at the same render time
this advantage is difficult to discern in the conventional photon mapping images.
Though the k-NN and VK methods both adapt the width
of the kernel to the local photon density, they are distinct
approaches which result in similar, but not identical, density
estimates. This is what accounts for the small differences in
blurring between our adaptive results and the k-NN “reference” images. However, as our results show, the same value
of n produces visually comparable renderings using the two
methods.
6. Discussion and Future Work
Specific trade-offs between the k-NN and VK methods have
been extensively studied within the density estimation literature [Sil86]. For computer graphics, a visual advantage of

564

W. Jarosz & M. Zwicker & H. W. Jensen / The Beam Radiance Estimate

Beam Radiance Estimate

Conventional Radiance Estimate
Reference Solution

k-NN (5:18:33)

Fixed (2:38:57)

Approx. Equal Time

k-NN (6:38)

Fixed (4:21)

Adaptive (6:22)

Fixed (4:15)

Figure 6: A comparison between the convention radiance estimate and our beam radiance estimate on the Stage scene with render times
provided as (hours:minutes:seconds). Our method (right) produces images with much less noise than an equal time rendering using conventional
volumetric photon mapping (middle) for both a fixed radius and an adaptive radius gathering approach. Our method does not require stepping but
matches the quality of conventional photon mapping if a very small step size is used (left).

the VK method is that the estimated function inherits all the
differential properties of the smoothing kernel. In contrast,
even with smooth kernels, the k-NN method results in estimates with a discontinuous first derivative. The VK method
does, unfortunately, require a pre-process to compute the kernel width for each photon. However, the amount of time to
compute adaptive radii for each photon using our method is
relatively inexpensive (typically less than 1–2% of the total
render time). On the other hand, k-NN gathering involves
maintaining a priority queue and is much more costly than a
fixed radius query. With our method, the gathering procedure
is identical whether an adaptive or fixed radius kernel is used
and no priority queue is needed.
Though adaptive kernel widths can be a distinct advantage,
in uniformly illuminated scenes a fixed radius may be sufficient. While assigning the radii is inexpensive, each resulting
BBH node consumes more memory than a kd-tree node due
to the additional 7 floating-point values needed to store the
bounding box and radius. If memory is limited and a fixed radius search is acceptable, then the regular photon map kd-tree
can be used to perform beam gathering by tracing a cylinder
through the kd-tree. This approach could be implemented in
the spirit of ray-bundle traversals [WMG∗ 07] by bounding
the cylinder using 6 planes. This offers the additional benefit of re-using the exact same data structure as conventional
photon mapping.
Our photon-disc approach using a BBH is not inherently
tied to participating media. VK density estimation could also
be applied to photon mapping at surfaces. It would be interesting to see whether a similar technique could be beneficial
for surfaces by querying the BBH for all photons that overlap
with a surface location. The pilot estimation preprocess may

also be beneficial at detecting and reducing boundary bias in
photon mapping for surfaces.
The advantages of beam gathering are more pronounced in
large open environments where ray marching needs to be performed over large distances and where potentially interesting
lighting is visible far away. One advantage of the conventional
radiance estimate, however, is that a fast preview render can
be obtained by using a large step-size. Since no step-size
is used for beam gathering, all photons intersecting a ray
need to be considered. In fact, these two approaches estimate
the lighting integral using different pdfs. The ray marching
computation employs exponential stepping, which distributes
photon queries with a pdf proportional to the transmission
term Tr . In contrast, our approach visits every photon that
intersects a line and so concentrates effort where the lighting
is important. Since the radiance seen by the eye is a product
of the lighting and the transmission, optimally we should
concentrate effort according to this product. One way of exploiting this could be to prune the BBH ray traversal using
Russian roulette based on some upper-bound on the transmission term and the number of photons in each subtree. Such a
scheme could further reduce render times by not considering
photons which are too distant and faint to contribute much to
the image. We leave this optimization as future work.
It would be interesting to explore what other useful
radiance estimate could be formed using the measurement equation formulation. For instance, Cammarano and
Jensen [CJ02] considered the problem of estimating the density of photons within four dimensional “cylinders” to properly simulate motion blurred caustics. This process could
easily be formulated as a measurement by defining the importance function over space-time.

c 2008 The Author(s)
Journal compilation c 2008 The Eurographics Association and Blackwell Publishing Ltd.

565

W. Jarosz & M. Zwicker & H. W. Jensen / The Beam Radiance Estimate

Beam Radiance Estimate

Conventional Radiance Estimate
Reference Solution

Approx. Equal Time

Fixed (14:43)

k-NN (4:03)

Fixed (3:19)

Adaptive (3:35)

Fixed (3:00)

k-NN (14:00)

Fixed (11:00)

k-NN (2:02)

Fixed (1:30)

Adaptive (1:53)

Fixed (1:30)

k-NN (52:45)

Fixed (18:37)

k-NN (1:12)

Fixed (1:07)

Adaptive (1:05)

Fixed (0:59)

Fixed

k-NN/Adaptive

Fixed

k-NN/Adaptive

k-NN (16:23)

Figure 7: The Cornell box, Cars, and Lighthouse scenes. Render times are shown as (minutes:seconds). For both the fixed and adaptive
gathering approaches our method produces noise-free results while conventional photon mapping suffers from significant noise, especially
around distant light sources.
c 2008 The Author(s)
Journal compilation c 2008 The Eurographics Association and Blackwell Publishing Ltd.

566

W. Jarosz & M. Zwicker & H. W. Jensen / The Beam Radiance Estimate

Photon splatting for participating media was presented
by Boudet et al. [BPPP05], where the conventional photon
mapping method needed to be meticulously transformed into
a splatting algorithm. An extra benefit of our reformulation
is that Equation 20 can immediately be seen as a splatting
operation and could therefore be efficiently implemented in
graphics hardware. Furthermore, whereas Boudet et al. only
considered fixed-size splats, our VK approach could easily
be used to adapt the splat size to the local photon density. A
splatting approach could also be used in software to accelerate
the computation for eye rays; however, the more general beam
gathering would need to be used for any secondary rays.
7. Conclusion
In this paper, we showed how volumetric photon mapping
can be expressed as a solution to the measurement equation.
This formulation showed that any measurement of radiance
within participating can be estimated using the photon map.
We applied this formulation by using the photon map to directly estimate accumulated in-scattered radiance along rays.
This approach was implemented using an efficient beam gathering method which can be used for both fixed and adaptive
width kernels. The resulting algorithm produces images with
significantly less noise than conventional volumetric photon
mapping using the same render time.
8. Acknowledgements
This work was supported in part by NSF grant CPA 0701992.
References
[BMP77] B REIMAN L., M EISEL W., P URCELL E.: Variable Kernel Estimates of Multivariate Densities. Technometrics 19, 2 (May 1977), 135–144.
[BPPP05] B OUDET A., P ITOT P., P RATMARTY D.,
PAULIN M.: Photon Splatting for Participating Media.
In GRAPHITE ’05 (New York, NY, USA, 2005), ACM
Press, pp. 197–204.
[Cha60] C HANDRASEKAR S.: Radiative Transfer. Dover
Publications, New York, 1960.
[CJ02] C AMMARANO M., J ENSEN H. W.: Time Dependent Photon Mapping. In EGRW ’02 (Aire-la-Ville,
Switzerland, Switzerland, 2002), Eurographics Association, pp. 135–144.
[CPP∗ 05] C EREZO E., P ÉREZ F., P UEYO X., S ERON F. J.,
COIS X. S ILLION F.: A survey on participating media
rendering techniques. The Visual Computer 21, 5 (June
2005), 303–328.
[JC98] J ENSEN H. W., C HRISTENSEN P. H.: Efficient
Simulation of Light Transport in Scences with Participating Media Using Photon Maps. In SIGGRAPH (New York,
NY, USA, 1998), ACM Press, pp. 311–320.

Light Transport. In SIGGRAPH (New York, NY, USA,
2001), ACM Press, pp. 511–518.
[JZJ08] JAROSZ W., Z WICKER M., J ENSEN H. W.: The
Beam Radiance Estimate for Volumetric Photon Mapping.
Tech. Rep. CS2008-0914, University of California, San
Diego, 2008.
[Kaj86] K AJIYA J. T.: The Rendering Equation. In SIGGRAPH (New York, NY, USA, 1986), ACM Press, pp. 143–
150.
[KH84] K AJIYA J. T., H ERZEN B. P. V.: Ray tracing
volume densities. In SIGGRAPH (New York, NY, USA,
1984), ACM Press, pp. 165–174.
[LW96] L AFORTUNE E. P., W ILLEMS Y. D.: Rendering Participating Media with Bidirectional Path Tracing.
In Rendering Techniques (London, UK, 1996), SpringerVerlag, pp. 91–100.
[PARN04] P REMOZE S., A SHIKHMIN M., R AMAMOOR THI R., NAYAR S. K.: Practical Rendering of Multiple
Scattering Effects in Participating Media. In Rendering
Techniques (2004), pp. 363–373.
[PKK00] PAULY M., KOLLIG T., K ELLER A.: Metropolis
Light Transport for Participating Media. In Rendering
Techniques (London, UK, 2000), Springer-Verlag, pp. 11–
22.
[PM93] PATTANAIK S. N., M UDUR S. P.: Computation
of global illumination in a participating medium by Monte
Carlo simulation. The Journal of Visualization and Computer Animation 4, 3 (July–Sept. 1993), 133–152.
[RT87] RUSHMEIER H. E., T ORRANCE K. E.: The zonal
method for calculating light intensities in the presence of
a participating medium. SIGGRAPH 21, 4 (Jul 1987),
293–302.
[Sil86] S ILVERMAN B.: Density Estimation for Statistics
and Data Analysis. Chapman and Hall, New York, NY,
1986.
[SRNN05] S UN B., R AMAMOORTHI R., NARASIMHAN
S. G., NAYAR S. K.: A practical analytic single scattering
model for real-time rendering. ACM Trans. Graph. 24, 3
(2005), 1040–1049.
[Sta95] S TAM J.: Multiple Scattering as a Diffusion Process. In Rendering Techniques (New York, NY, 1995),
Hanrahan P. M., Purgathofer W., (Eds.), Springer-Verlag,
pp. 41–50.
[Vea98] V EACH E.: Robust Monte Carlo Methods for Light
Transport Simulation. PhD thesis, 1998.
[WMG∗ 07] WALD I., M ARK W. R., G ÜNTHER J., B OU LOS S., I ZE T., H UNT W., PARKER S. G., S HIRLEY P.:
State of the Art in Ray Tracing Animated Scenes. In Eurographics (Prague, Czech Republic, September 2007),
Eurographics Association.

[JMLH01] J ENSEN H. W., M ARSCHNER S. R., L EVOY
M., H ANRAHAN P.: A Practical Model for Subsurface
c 2008 The Author(s)
Journal compilation c 2008 The Eurographics Association and Blackwell Publishing Ltd.

